define("contact-summary/modules/contact-summary.config",["common/angular"],function(t){"use strict";function e(t,e,n,r,c){c.debugEnabled(t.debug),e.when("/",{controller:"ContactSummaryController",controllerAs:"ContactSummaryCtrl",templateUrl:t.pathBaseUrl+t.pathTpl+"mainTemplate.html",resolve:{}}).otherwise({redirectTo:"/"}),n.defaults.stripTrailingSlashes=!1,r.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}t.module("contactsummary.config",["contactsummary.constants"]).config(e),e.$inject=["settings","$routeProvider","$resourceProvider","$httpProvider","$logProvider"]}),define("contact-summary/modules/contact-summary.constants",["common/angular"],function(t){"use strict";t.module("contactsummary.constants",[]).constant("settings",{classNamePrefix:"contactSummary-",contactId:decodeURIComponent((new RegExp("[?|&]cid=([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null,debug:!0,pathApp:"",pathRest:CRM.url("civicrm/ajax/rest"),pathBaseUrl:CRM.vars.contactsummary.baseURL+"/",pathTpl:"views/"})}),define("contact-summary/controllers/contact-summary.controller",[],function(){"use strict";function t(t,e){t.debug("Controller: ContactSummaryController");var n=e.pathBaseUrl+e.pathTpl,r=this;r.ready=!1,r.partials={keyDetails:n+"/include/keyDetails.html",keyDates:n+"/include/keyDates.html"}}return t.__name="ContactSummaryController",t.$inject=["$log","settings"],t}),define("contact-summary/controllers/key-dates.controller",["common/angular","common/moment"],function(t,e){"use strict";function n(n,r,c,o){function i(t){m.dates.push({title:t.title+" (Start)",date:t.start_date,future:s(t.start_date)}),t.end_date&&m.dates.push({title:t.title+" (End)",date:t.end_date,future:s(t.end_date)})}function a(){r.get().then(function(e){return t.forEach(e,function(t){i(t),"1"===t.is_current&&m.activeContracts++}),c.get()}).then(function(n){t.forEach(n,function(t){var n=e(t.end_date);n.isValid()&&!s(n)||m.activeRoles++})}).finally(function(){m.ready=!0})}function s(t){return e().diff(t)<0}function u(){m.dates=[],a()}n.debug("Controller: KeyDatesController");var m=this;m.ready=!1,m.dates=[],m.activeContracts=0,m.activeRoles=0,function(){a(),o.subscribe("contract-refresh",u)}()}return n.__name="KeyDatesController",n.$inject=["$log","contractService","jobRoleService","pubSub"],n}),define("contact-summary/controllers/key-details.controller",["common/lodash","common/moment"],function(t,e){"use strict";function n(e,n,r,c){function o(){n.get().then(function(t){return a.contactDetails=t,r.getPrimary()}).then(function(e){if(t.isEmpty(e))return void(a.primaryContract=null);a.primaryContract=e}).then(function(t){return r.getLengthOfService()}).then(function(t){a.lengthOfService=t}).finally(function(){a.ready=!0})}function i(){r.resetContracts(),n.data.item={},o()}e.debug("Controller: KeyDetailsController");var a=this;a.ready=!1,function(){o(),c.subscribe("contract-refresh",i)}()}return n.__name="KeyDetailsController",n.$inject=["$log","contactDetailsService","contractService","pubSub"],n}),define("contact-summary/modules/contact-summary.controllers",["common/angular","contact-summary/controllers/contact-summary.controller","contact-summary/controllers/key-dates.controller","contact-summary/controllers/key-details.controller"],function(t,e,n,r){"use strict";t.module("contactsummary.controllers",[]).controller(e.__name,e).controller(n.__name,n).controller(r.__name,r)}),define("contact-summary/modules/contact-summary.core",["common/angular","common/services/pub-sub"],function(t){"use strict";t.module("contactsummary.core",["ngRoute","ngResource","ui.bootstrap","common.services"])}),define("contact-summary/directives/donut-chart.directive",["common/angular","common/d3"],function(t,e){"use strict";function n(t){this.height=this.width=t[0].clientWidth,this.radius=this.width/2||60,this.thickness=this.thickness||15}function r(){return e.svg.arc().innerRadius(this.radius-this.thickness).outerRadius(this.radius)}function c(t,n,r){var c=e.scale.category20();return t.selectAll("path").data(r).enter().append("path").attr("fill",function(t,e){return c(e)}).attr("class",function(t,e){return"chart-color-"+e}).attr("d",n)}function o(){return e.layout.pie().sort(null).value(function(t){return t.value[this.itemKey]}.bind(this))(e.entries(this.items))}function i(t){return e.select(t).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.width/2+","+this.height/2+")")}function a(e){return e.debug("Directive: csDonutChart"),{controllerAs:"CsDonutChartCtrl",restrict:"AE",scope:{radius:"@",thickness:"@",items:"=",itemKey:"@",ready:"="},controller:["$scope","$element",function(e,a){this.drawChart=function(){n.call(t.extend(this,e),a),c(i.call(this,a[0]),r.call(this),o.call(this))}}],link:function(t,e,n,r){var c=t.$watch(function(){return t.ready},function(t,e){!0===t&&(r.drawChart(),c())})}}}return a.__name="csDonutChart",a.$inject=["$log"],a}),define("contact-summary/modules/contact-summary.directives",["common/angular","contact-summary/directives/donut-chart.directive"],function(t,e){"use strict";t.module("contactsummary.directives",[]).directive(e.__name,e)}),define("contact-summary/modules/contact-summary.run",["common/angular"],function(t){"use strict";function e(t,e,n,r){r.debug("app.run"),e.pathTpl=t.pathTpl,e.prefix=t.classNamePrefix}t.module("contactsummary.run",["contactsummary.constants"]).run(e),e.$inject=["settings","$rootScope","$q","$log"]}),function(t){define("contact-summary/services/api.service",["common/angular"],function(e){"use strict";function n(n,r){function c(n,r,c,o){if(!e.isDefined(n))throw new Error("Entity name not provided");if(!e.isDefined(c))throw new Error("Action not provided");return r=e.extend({entity:n,action:c,sequential:1,json:1,rowCount:0},r),o?t.param(r):r}function o(t,e,n){return a("get",c(t,e,"get"),n)}function i(t,n,r,o){return o=e.extend({headers:{"Content-Type":"application/x-www-form-urlencoded"}},o),a("post",c(t,n,r,!0),o)}function a(t,c,o){return o=e.extend({method:t,url:"/civicrm/ajax/rest"},"post"===t?{data:c}:{params:c},o),n(o).then(function(t){return t.is_error?r.reject(t):t.data}).catch(function(t){return t})}return{get:o,post:i}}return n.__name="apiService",n.$inject=["$http","$q"],n})}(CRM.$),define("contact-summary/services/contact-details.service",["common/lodash","common/moment"],function(t,e){"use strict";function n(n,r,c,o,i){function a(){var t=n.defer();return u().then(function(){t.resolve(m.getData())}),t.promise}function s(t){return e().diff(e(t,"YYYY-MM-DD"),"years")}function u(){var r=n.defer();if(t.isEmpty(m.getData())){var o=i.contactId;c.get("Contact",{contact_id:o,return:"birth_date"}).then(function(t){if(0===t.values.length)throw new Error("Contact with ID "+o+" not found");var n=t.values[0].birth_date,c=e(n,"YYYY-MM-DD").isValid()?s(n):"";m.setDataKey("id",o),m.setDataKey("dateOfBirth",n),m.setDataKey("age",c),r.resolve()}).catch(function(t){r.reject(t)})}else r.resolve();return r.promise}r.debug("Service: contactDetailsService");var m=o.createInstance();return m.get=a,m}return n.__name="contactDetailsService",n.$inject=["$q","$log","apiService","modelService","settings"],n}),define("contact-summary/services/contact.service",["common/lodash"],function(t){"use strict";function e(e,n,r,c,o){function i(){return a().then(function(){return m.getData()})}function a(){var e=n.defer();return t.isEmpty(m.getData())?s().then(u).then(function(){e.resolve()}):e.resolve(),e.promise}function s(){return c.get().then(function(t){m.setDataKey("id",t.id),m.setDataKey("dateOfBirth",t.dateOfBirth),m.setDataKey("age",t.age)})}function u(){return o.get().then(function(t){m.setDataKey("contract",t)})}e.debug("Service: contactService");var m=r.createInstance();return m.get=i,m}return e.__name="contactService",e.$inject=["$log","$q","modelService","contactDetailsService","contractService"],e}),define("contact-summary/services/contract.service",["common/angular","common/lodash"],function(t,e){"use strict";function n(n,c,o,i,a){function s(){var e=n.defer(),r=[];return t.forEach(p,function(t){var e={};e.id=t.id,e.is_primary=t.is_primary,e.is_current=t.is_current,e.revision_id=null,t.api_HRJobContractRevision_getcurrentrevision&&(e.revision_id=t.api_HRJobContractRevision_getcurrentrevision.values.id);var n=_.getContractDetails(t.id).then(function(t){e.title=t.title,e.start_date=t.period_start_date,e.end_date=t.period_end_date,e.type=t.contract_type,e.pay=t.pay,e.hours=t.hours}).then(function(){_.collection.insertItem(t.id,e)});r.push(n)}),n.all(r).catch(function(t){c.error("Something went wrong",t)}).finally(function(){e.resolve()}),e.promise}function u(){return y().then(function(){return _.getCollection()})}function m(){return _.collection.get()}function l(){var t=n.defer();return e.isEmpty(p)?a.get().then(function(t){var e={contact_id:t.id,"api.HRJobContractRevision.getcurrentrevision":{jobcontract_id:"$value.id"}};return o.get("HRJobContract",e)}).then(function(e){var n=e.values.filter(function(t){return 0===parseInt(t.deleted)});if(0===n.length)return t.reject("No job contract found");p=n,t.resolve(p)}).catch(function(e){t.reject(e)}):t.resolve(p),t.promise}function d(t){var e=function(t){var e={};0!==t.api_HRJobPay_get.values.length&&(e.amount=t.api_HRJobPay_get.values[0].pay_amount,e.currency=t.api_HRJobPay_get.values[0].pay_currency),t.pay=e},c=function(t){var e={};0!==t.api_HRJobHour_get.values.length&&(e.amount=t.api_HRJobHour_get.values[0].hours_amount,e.unit=t.api_HRJobHour_get.values[0].hours_unit),t.hours=e},i={jobcontract_id:t,"api.HRJobPay.get":{jobcontract_id:t},"api.HRJobHour.get":{jobcontract_id:t}};return r.getContractDetails||(r.getContractDetails=o.post("HRJobDetails",i,"get").then(function(r){if(0===r.values.length)return n.reject("No details found for contract revision with ID "+t);var o=r.values[0];return e(o),c(o),o})),r.getContractDetails}function f(){var t=n.defer();return a.get().then(function(t){return o.post("HRJobContract",{sequential:0,contact_id:t.id},"getlengthofserviceymd")}).then(function(e){e.is_error?t.reject(e):t.resolve(e.values)}).catch(function(e){t.reject(e)}),t.promise}function v(){return _.get().then(function(t){var n=e.sortBy(t,function(t){return[t.end_date,+t.is_primary]});return e.last(n)||{}})}function y(){var t=n.defer();return e.isEmpty(_.collection.get())?_.getContracts().then(s).finally(function(){t.resolve()}):t.resolve(),t.promise}function h(){_.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}}}function g(){p=[],r={},h()}c.debug("Service: Contract Service");var p=[],_={};return _.get=u,_.getCollection=m,_.getContracts=l,_.getContractDetails=d,_.getLengthOfService=f,_.getPrimary=v,_.resetContracts=g,h(),_}var r={};return n.__name="contractService",n.$inject=["$q","$log","apiService","modelService","contactDetailsService"],n}),define("contact-summary/services/item.service",["common/angular","common/lodash","common/moment"],function(t,e,n){"use strict";function r(){function e(){var t=Object.create(o);return t.item={},t}function n(){return this.item}function r(e){if(!t.isObject(e))throw new TypeError("Data must be of type Object");this.item=e}function c(t,e){this.item[t]=e}var o={};return o.createInstance=e,o.get=n,o.set=r,o.setKey=c,o}return r.__name="itemService",r}),define("contact-summary/services/job-role.service",["common/angular","common/lodash"],function(t,e){"use strict";function n(n,r,c,o,i){function a(){return u().then(function(){return m.getCollection()})}function s(){return m.collection.get()}function u(){var r=n.defer();return e.isEmpty(m.collection.get())?i.get().then(function(e){var o=[];if(t.forEach(e,function(t){o.push(t.id)}),0===o.length)return n.reject("No job roles found for contracts");c.post("HrJobRoles",{job_contract_id:{IN:o}},"get").then(function(t){if(0===t.values.length)return n.reject("No job roles found for contracts");var e=t.values.map(function(t){return{id:t.id,title:t.title,department:t.department,status:t.status,start_date:t.start_date,end_date:t.end_date}});m.collection.set(e)}).finally(function(){r.resolve()})}):r.resolve(),r.promise}r.debug("Service: jobRoleService");var m={};return m.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}},m.get=a,m.getCollection=s,m}return n.__name="jobRoleService",n.$inject=["$q","$log","apiService","modelService","contractService"],n}),define("contact-summary/services/leave.service",["common/angular","common/lodash","common/moment"],function(t,e,n){"use strict";function r(r,o,i,a,s,u){function m(e){var n=P.collection.getItem(e)||{};t.forEach(H,function(t){if("1"===t.is_active){var e=t.id;n.hasOwnProperty(e)||(n[e]={}),n[e].type_id=e,n[e].title=t.title,n[e].credit_activity_type_id=t.credit_activity_type_id?t.credit_activity_type_id:null,n[e].debit_activity_type_id=t.debit_activity_type_id?t.debit_activity_type_id:null,n[e].entitled=0,n[e].taken=0}}),P.collection.insertItem(e,n)}function l(e){var n=P.collection.getItem(e),r={};t.forEach(H,function(t){t.credit_activity_type_id&&(r[t.credit_activity_type_id]=t.id),t.debit_activity_type_id&&(r[t.debit_activity_type_id]=t.id)}),t.forEach($,function(t){var e;if(r.hasOwnProperty(t.activity_type_id)&&(e=r[t.activity_type_id]),e){if(!n.hasOwnProperty(e))return;var c=Math.ceil(t.absence_range.approved_duration/60),o=+(c/8).toFixed(1);"toil"===n[e].title.toLowerCase()&&t.activity_type_id===n[e].credit_activity_type_id?n[e].entitled+=o:n[e].taken+=o}}),P.collection.insertItem(e,n)}function d(e){var n=P.collection.getItem(e);t.forEach(E,function(t){var e=t.type_id;n.hasOwnProperty(e)&&"toil"!==n[e].title.toLowerCase()&&(n[e].entitled=+t.amount)}),P.collection.insertItem(e,n)}function f(t){m(t),d(t),l(t)}function v(){return R(void 0).then(function(){return P.getData()})}function y(){var t=r.defer();return e.isEmpty(H)?a.get("HRAbsenceType").then(function(e){if(0===e.values.length)throw new Error("No absence type not found");H=e.values,t.resolve(H)}):t.resolve(H),t.promise}function h(t){var n=r.defer();return u.get().then(function(e){var n={target_contact_id:e.id,period_id:[t],options:{"absence-range":1},sequential:0};return a.post("Activity",n,"getabsences")}).then(function(t){$=e.filter(t.values,function(t){return"2"===t.status_id}),n.resolve($)}),n.promise}function g(){return P.collection.get()}function p(){var t,e=r.defer();return c.getCurrent||(P.getCurrentPeriod().then(function(n){n.hasOwnProperty("id")?(t=n.id,R(t).then(function(){e.resolve(P.collection.getItem(t))})):e.resolve({})}),c.getCurrent=e.promise),c.getCurrent}function _(){return D().then(function(t){for(var e={},r=n(),c=0;c<t.length;c++){var o=n(t[c].start_date,"YYYY-MM-DD HH:mm:ss"),i=n(t[c].end_date,"YYYY-MM-DD HH:mm:ss");r.diff(o)>=0&&r.diff(i)<=0&&(e=t[c])}return e})}function b(){}function C(t){var e=r.defer();return u.get().then(function(e){var n={contact_id:e.id,period_id:t,options:{"absence-range":1}};return a.get("HRAbsenceEntitlement",n)}).then(function(t){E=t.values,e.resolve(E)}),e.promise}function D(){var t=r.defer();return e.isEmpty(I)?a.get("HRAbsencePeriod").then(function(e){if(0===e.values.length)return t.reject("No absence periods found");I=e.values,I=i("orderBy")(I,"start_date"),t.resolve(I)}).catch(function(e){o.debug("An error has occurred",e),t.reject(e)}):t.resolve(I),t.promise}function S(){var t,e=r.defer();return j().then(function(n){n.hasOwnProperty("id")?(t=n.id,R(t).then(function(){e.resolve(P.collection.getItem(t))})):e.resolve({})}),e.promise}function j(){var t,e={};return P.getCurrentPeriod().then(function(e){return t=e,D()}).then(function(n){var r=n.indexOf(t);return-1!==r&&r>0&&(e=n[r-1]),e})}function w(t){var e=r.defer();return P.getCurrentPeriod().then(function(n){if(n.hasOwnProperty("id")){var c=n.id;a.post("ContactSummary",{absence_types:t,period_id:c},"getabsenceaggregate").then(function(t){if(0===t.values.length)return r.reject("Staff average not returned");var n=Math.ceil(t.values[0].result/60),c=+(n/8).toFixed(1);e.resolve(c)})}else e.resolve(0)}),e.promise}function R(t){var n=r.defer();return e.isEmpty(P.collection.getItem(t))?P.getAbsenceTypes().then(function(){return P.getAbsences(t)}).then(function(){return P.getEntitlement(t)}).then(function(){return f(t)}).then(function(){n.resolve()}).catch(function(t){o.debug("An error has occurred",t),n.reject(t)}):n.resolve(),n.promise}o.debug("Service: leaveService");var $,E,I,H=[],P={};return P.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}},P.get=v,P.getAbsenceTypes=y,P.getAbsences=h,P.getCollection=g,P.getCurrent=p,P.getCurrentPeriod=_,P.getDepartmentAverage=b,P.getEntitlement=C,P.getPrevious=S,P.getStaffAverage=w,P}var c={};return r.__name="leaveService",r.$inject=["$q","$log","$filter","apiService","modelService","contactDetailsService"],r}),define("contact-summary/services/model.service",["common/lodash","contact-summary/modules/contact-summary.services"],function(t,e){"use strict";function n(t){function e(){var e=Object.create(o);return e.data=t.createInstance(),e}function n(){return this.data.get()}function r(t){this.data.set(t)}function c(t,e){this.data.setKey(t,e)}var o={};return o.data={},o.createInstance=e,o.getData=n,o.setData=r,o.setDataKey=c,o}return n.__name="modelService",n.$inject=["itemService"],n}),define("contact-summary/modules/contact-summary.services",["common/angular","contact-summary/services/api.service","contact-summary/services/contact-details.service","contact-summary/services/contact.service","contact-summary/services/contract.service","contact-summary/services/item.service","contact-summary/services/job-role.service","contact-summary/services/leave.service","contact-summary/services/model.service"],function(t,e,n,r,c,o,i,a,s){"use strict";t.module("contactsummary.services",[]).factory(e.__name,e).factory(n.__name,n).factory(r.__name,r).factory(c.__name,c).factory(o.__name,o).factory(i.__name,i).factory(a.__name,a).factory(s.__name,s)}),define("contact-summary/modules/contact-summary.module",["common/angular","contact-summary/modules/contact-summary.config","contact-summary/modules/contact-summary.constants","contact-summary/modules/contact-summary.controllers","contact-summary/modules/contact-summary.core","contact-summary/modules/contact-summary.directives","contact-summary/modules/contact-summary.run","contact-summary/modules/contact-summary.services"],function(t){t.module("contactsummary",["contactsummary.core","contactsummary.config","contactsummary.run","contactsummary.constants","contactsummary.controllers","contactsummary.directives","contactsummary.services"])}),function(t,e){e.config({urlArgs:"bust="+(new Date).getTime(),paths:{"contact-summary":t.vars.contactsummary.baseURL+"/js/src/contact-summary"}}),e(["contact-summary/modules/contact-summary.module"],function(){"use strict";document.dispatchEvent("function"==typeof window.CustomEvent?new window.CustomEvent("contactsummaryReady"):function(){var t=document.createEvent("Event");return t.initEvent("contactsummaryReady",!0,!0),t}())})}(CRM,require);