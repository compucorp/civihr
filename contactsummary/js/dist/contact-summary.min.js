define("contact-summary/modules/filters",["common/angular"],function(t){"use strict";return t.module("contactsummary.filters",[])}),define("contact-summary/modules/services",["common/angular"],function(t){"use strict";return t.module("contactsummary.services",[])}),define("contact-summary/modules/settings",["common/angular"],function(t){"use strict";return t.module("contactsummary.settings",[]).constant("settings",{classNamePrefix:"contactSummary-",contactId:decodeURIComponent((new RegExp("[?|&]cid=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null,debug:!0,pathApp:"",pathRest:CRM.url("civicrm/ajax/rest"),pathBaseUrl:CRM.vars.contactsummary.baseURL+"/",pathTpl:"views/"})}),define("contact-summary/modules/controllers",["common/angular"],function(t){"use strict";return t.module("contactsummary.controllers",[])}),define("contact-summary/services/item",["common/moment","contact-summary/modules/services"],function(t,e){"use strict";function n(){var t={};return t.createInstance=function(){var t=Object.create(this);return t.item={},t},t.get=function(){return this.item},t.set=function(t){if(!angular.isObject(t))throw new TypeError("Data must be of type Object");this.item=t},t.setKey=function(t,e){this.item[t]=e},t}e.factory("ItemService",n)}),define("contact-summary/services/model",["contact-summary/modules/services","contact-summary/services/item"],function(t){"use strict";function e(t){var e={};return e.data={},e.createInstance=function(){var e=Object.create(this);return e.data=t.createInstance(),e},e.getData=function(){return this.data.get()},e.setData=function(t){this.data.set(t)},e.setDataKey=function(t,e){this.data.setKey(t,e)},e}t.factory("ModelService",["ItemService",e])}),define("contact-summary/services/api",["contact-summary/modules/services"],function(t){"use strict";t.factory("ApiService",["$http","$q",function(t,e){function n(t,e,n,r){if(!angular.isDefined(t))throw new Error("Entity name not provided");if(!angular.isDefined(n))throw new Error("Action not provided");return e=angular.extend({entity:t,action:n,sequential:1,json:1,rowCount:0},e),r?jQuery.param(e):e}function r(n,r,i){return i=angular.extend({method:n,url:"/civicrm/ajax/rest"},"post"===n?{data:r}:{params:r},i),t(i).then(function(t){return t.is_error?e.reject(t):t.data})["catch"](function(t){return t})}return{get:function(t,e,i){return r("get",n(t,e,"get"),i)},post:function(t,e,i,c){return c=angular.extend({headers:{"Content-Type":"application/x-www-form-urlencoded"}},c),r("post",n(t,e,i,!0),c)},getValue:function(t,e){},create:function(t,e){},update:function(t,e){},"delete":function(t,e){}}}])}),define("contact-summary/services/contactDetails",["common/lodash","common/moment","contact-summary/modules/services","contact-summary/modules/settings","contact-summary/services/api","contact-summary/services/model"],function(t,e,n){"use strict";function r(n,r,i,c,o){function a(){var r=n.defer();if(t.isEmpty(u.getData())){var c=o.contactId;i.get("Contact",{contact_id:c,"return":"birth_date"}).then(function(t){if(0===t.values.length)throw new Error("Contact with ID "+c+" not found");var n=t.values[0].birth_date,i=e(n,"YYYY-MM-DD").isValid()?s(n):"";u.setDataKey("id",c),u.setDataKey("dateOfBirth",n),u.setDataKey("age",i),r.resolve()})["catch"](function(t){r.reject(t)})}else r.resolve();return r.promise}function s(t){return e().diff(e(t,"YYYY-MM-DD"),"years")}r.debug("Service: ContactDetailsService");var u=c.createInstance();return u.get=function(){var t=this,e=n.defer();return a().then(function(){e.resolve(t.getData())}),e.promise},u}n.factory("ContactDetailsService",["$q","$log","ApiService","ModelService","settings",r])}),define("contact-summary/services/leave",["common/lodash","contact-summary/modules/services","common/moment","contact-summary/services/api","contact-summary/services/model","contact-summary/services/contactDetails"],function(t,e,n){"use strict";function r(e,r,c,o,a,s){function u(){var t,e={};return y.getCurrentPeriod().then(function(e){return t=e,m()}).then(function(n){var r=n.indexOf(t);return-1!==r&&r>0&&(e=n[r-1]),e})}function l(n){var i=e.defer();return t.isEmpty(y.collection.getItem(n))?y.getAbsenceTypes().then(function(){return y.getAbsences(n)}).then(function(){return y.getEntitlement(n)}).then(function(){return d(n)}).then(function(){i.resolve()})["catch"](function(t){r.debug("An error has occurred",t),i.reject(t)}):i.resolve(),i.promise}function m(){var n=e.defer();return t.isEmpty(_)?o.get("HRAbsencePeriod").then(function(t){return 0===t.values.length?n.reject("No absence periods found"):(_=t.values,_=c("orderBy")(_,"start_date"),void n.resolve(_))})["catch"](function(t){r.debug("An error has occurred",t),n.reject(t)}):n.resolve(_),n.promise}function d(t){f(t),v(t),h(t)}function f(t){var e=y.collection.getItem(t)||{};angular.forEach(b,function(t){if("1"===t.is_active){var n=t.id;e.hasOwnProperty(n)||(e[n]={}),e[n].type_id=n,e[n].title=t.title,e[n].credit_activity_type_id=t.credit_activity_type_id?t.credit_activity_type_id:null,e[n].debit_activity_type_id=t.debit_activity_type_id?t.debit_activity_type_id:null,e[n].entitled=0,e[n].taken=0}}),y.collection.insertItem(t,e)}function v(t){var e=y.collection.getItem(t);angular.forEach(p,function(t){var n=t.type_id;e.hasOwnProperty(n)&&"toil"!==e[n].title.toLowerCase()&&(e[n].entitled=+t.amount)}),y.collection.insertItem(t,e)}function h(t){var e=y.collection.getItem(t),n={};angular.forEach(b,function(t){t.credit_activity_type_id&&(n[t.credit_activity_type_id]=t.id),t.debit_activity_type_id&&(n[t.debit_activity_type_id]=t.id)}),angular.forEach(g,function(t){var r;if(n.hasOwnProperty(t.activity_type_id)&&(r=n[t.activity_type_id]),r){if(!e.hasOwnProperty(r))return;var i=Math.ceil(t.absence_range.approved_duration/60),c=+(i/8).toFixed(1);"toil"===e[r].title.toLowerCase()&&t.activity_type_id===e[r].credit_activity_type_id?e[r].entitled+=c:e[r].taken+=c}}),y.collection.insertItem(t,e)}r.debug("Service: LeaveService");var y={};y.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}},y.getCollection=function(){return this.collection.get()},y.getCurrentPeriod=function(){return m().then(function(t){for(var e={},r=n(),i=0;i<t.length;i++){var c=n(t[i].start_date,"YYYY-MM-DD HH:mm:ss"),o=n(t[i].end_date,"YYYY-MM-DD HH:mm:ss");r.diff(c)>=0&&r.diff(o)<=0&&(e=t[i])}return e})},y.get=function(){var t,e=this;return l(t).then(function(){return e.getData()})},y.getCurrent=function(){var t,n=this,r=e.defer();return i.getCurrent||(y.getCurrentPeriod().then(function(e){e.hasOwnProperty("id")?(t=e.id,l(t).then(function(){r.resolve(n.collection.getItem(t))})):r.resolve({})}),i.getCurrent=r.promise),i.getCurrent},y.getPrevious=function(){var t,n=this,r=e.defer();return u().then(function(e){e.hasOwnProperty("id")?(t=e.id,l(t).then(function(){r.resolve(n.collection.getItem(t))})):r.resolve({})}),r.promise},y.getEntitlement=function(t){var n=e.defer();return s.get().then(function(e){var n={contact_id:e.id,period_id:t,options:{"absence-range":1}};return o.get("HRAbsenceEntitlement",n)}).then(function(t){return 0===t.values.length?{}:(p=t.values,void n.resolve(p))}),n.promise},y.getAbsences=function(n){var r=e.defer();return s.get().then(function(t){var e={target_contact_id:t.id,period_id:[n],options:{"absence-range":1},sequential:0};return o.post("Activity",e,"getabsences")}).then(function(e){g=t.filter(e.values,function(t){return"2"===t.status_id}),r.resolve(g)}),r.promise},y.getAbsenceTypes=function(){var n=e.defer();return t.isEmpty(b)?o.get("HRAbsenceType").then(function(t){if(0===t.values.length)throw new Error("No absence type not found");b=t.values,n.resolve(b)}):n.resolve(b),n.promise},y.getStaffAverage=function(t){var n=e.defer(),r=0;return y.getCurrentPeriod().then(function(i){if(i.hasOwnProperty("id")){var c=i.id;o.post("ContactSummary",{absence_types:t,period_id:c},"getabsenceaggregate").then(function(t){if(0===t.values.length)return e.reject("Staff average not returned");var r=Math.ceil(t.values[0].result/60),i=+(r/8).toFixed(1);n.resolve(i)})}else n.resolve(r)}),n.promise},y.getDepartmentAverage=function(){};var g,p,_,b=[];return y}var i={};e.factory("LeaveService",["$q","$log","$filter","ApiService","ModelService","ContactDetailsService",r])}),define("contact-summary/services/contract",["common/lodash","contact-summary/modules/services","contact-summary/services/api","contact-summary/services/contactDetails","contact-summary/services/model"],function(t,e){"use strict";function n(e,n,i,c,o){function a(){l.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}}}function s(){var n=e.defer();return t.isEmpty(l.collection.get())?l.getContracts().then(u)["finally"](function(){n.resolve()}):n.resolve(),n.promise}function u(){var t=e.defer(),r=[];return angular.forEach(m,function(t){var e={};e.id=t.id,e.is_primary=t.is_primary,e.is_current=t.is_current,e.revision_id=null,t.api_HRJobContractRevision_getcurrentrevision&&(e.revision_id=t.api_HRJobContractRevision_getcurrentrevision.values.id);var n=l.getContractDetails(t.id).then(function(t){e.title=t.title,e.start_date=t.period_start_date,e.end_date=t.period_end_date,e.type=t.contract_type,e.pay=t.pay,e.hours=t.hours}).then(function(){l.collection.insertItem(t.id,e)});r.push(n)}),e.all(r)["catch"](function(t){n.error("Something went wrong",t)})["finally"](function(){t.resolve()}),t.promise}n.debug("Service: Contract Service");var l={};a(),l.getCollection=function(){return this.collection.get()},l.get=function(){var t=this;return s().then(function(){return t.getCollection()})},l.getPrimary=function(){return this.get().then(function(e){var n=t.sortBy(e,function(t){return[t.end_date,+t.is_primary]});return t.last(n)||{}})},l.resetContracts=function(){m=[],r={},a()},l.getContracts=function(){var n=e.defer();return t.isEmpty(m)?o.get().then(function(t){var e={contact_id:t.id,"api.HRJobContractRevision.getcurrentrevision":{jobcontract_id:"$value.id"}};return i.get("HRJobContract",e)}).then(function(t){var e=t.values.filter(function(t){return 0===parseInt(t.deleted)});return 0===e.length?n.reject("No job contract found"):(m=e,void n.resolve(m))})["catch"](function(t){n.reject(t)}):n.resolve(m),n.promise},l.getContractDetails=function(t){var n=function(t){var e={};0!==t.api_HRJobPay_get.values.length&&(e.amount=t.api_HRJobPay_get.values[0].pay_amount,e.currency=t.api_HRJobPay_get.values[0].pay_currency),t.pay=e},c=function(t){var e={};0!==t.api_HRJobHour_get.values.length&&(e.amount=t.api_HRJobHour_get.values[0].hours_amount,e.unit=t.api_HRJobHour_get.values[0].hours_unit),t.hours=e},o={jobcontract_id:t,"api.HRJobPay.get":{jobcontract_id:t},"api.HRJobHour.get":{jobcontract_id:t}};return r.getContractDetails||(r.getContractDetails=i.post("HRJobDetails",o,"get").then(function(r){if(0===r.values.length)return e.reject("No details found for contract revision with ID "+t);var i=r.values[0];return n(i),c(i),i})),r.getContractDetails},l.getLengthOfService=function(){var t=e.defer();return o.get().then(function(t){return i.post("HRJobContract",{sequential:0,contact_id:t.id},"getlengthofserviceymd")}).then(function(e){e.is_error?t.reject(e):t.resolve(e.values)})["catch"](function(e){t.reject(e)}),t.promise};var m=[];return l}var r={};e.factory("ContractService",["$q","$log","ApiService","ModelService","ContactDetailsService",n])}),define("contact-summary/services/contact",["common/lodash","contact-summary/modules/services","contact-summary/services/model","contact-summary/services/leave","contact-summary/services/contactDetails","contact-summary/services/contract"],function(t,e){"use strict";function n(e,n,r,i,c,o){function a(){var e=n.defer();return t.isEmpty(m.getData())?s().then(u).then(l).then(function(){e.resolve()}):e.resolve(),e.promise}function s(){return i.get().then(function(t){m.setDataKey("id",t.id),m.setDataKey("dateOfBirth",t.dateOfBirth),m.setDataKey("age",t.age)})}function u(){return o.get().then(function(t){m.setDataKey("contract",t)})}function l(){return c.get().then(function(t){m.setDataKey("leave",t)})}e.debug("Service: ContactService");var m=r.createInstance();return m.get=function(){var t=this;return a().then(function(){return t.getData()})},m}e.factory("ContactService",["$log","$q","ModelService","ContactDetailsService","LeaveService","ContractService",n])}),define("contact-summary/controllers/contactSummary",["contact-summary/modules/controllers","contact-summary/modules/settings","contact-summary/services/contact"],function(t){"use strict";function e(t,e,n){t.debug("Controller: ContactSummaryCtrl");var r=n.pathBaseUrl+n.pathTpl;this.partials={keyDetails:r+"/include/keyDetails.html",keyDates:r+"/include/keyDates.html",leave:r+"/include/leave.html",sickness:r+"/include/sickness.html"},this.ready=!1}t.controller("ContactSummaryCtrl",["$log","ContactService","settings",e])}),define("contact-summary/services/jobRole",["common/lodash","contact-summary/modules/services","contact-summary/services/api","contact-summary/services/contract","contact-summary/services/model"],function(t,e){"use strict";function n(e,n,r,i,c){function o(){var n=e.defer();return t.isEmpty(a.collection.get())?c.get().then(function(t){var i=[];return angular.forEach(t,function(t){i.push(t.id)}),0===i.length?e.reject("No job roles found for contracts"):void r.post("HrJobRoles",{job_contract_id:{IN:i}},"get").then(function(t){if(0===t.values.length)return e.reject("No job roles found for contracts");var n=t.values.map(function(t){return{id:t.id,title:t.title,department:t.department,status:t.status,start_date:t.start_date,end_date:t.end_date}});a.collection.set(n)})["finally"](function(){n.resolve()})}):n.resolve(),n.promise}n.debug("Service: JobRoleService");var a={};return a.collection={items:{},insertItem:function(t,e){this.items[t]=e},getItem:function(t){return this.items[t]},set:function(t){this.items=t},get:function(){return this.items}},a.getCollection=function(){return this.collection.get()},a.get=function(){var t=this;return o().then(function(){return t.getCollection()})},a}e.factory("JobRoleService",["$q","$log","ApiService","ModelService","ContractService",n])}),define("contact-summary/controllers/keyDates",["common/moment","contact-summary/modules/controllers","contact-summary/services/contract","contact-summary/services/jobRole","common/services/pub-sub"],function(t,e){"use strict";function n(t){this.dates.push({title:t.title+" (Start)",date:t.start_date,future:r(t.start_date)}),t.end_date&&this.dates.push({title:t.title+" (End)",date:t.end_date,future:r(t.end_date)})}function r(e){return t().diff(e)<0}function i(e,i,c,o){e.debug("Controller: KeyDatesCtrl");var a=this;this.ready=!1,this.dates=[],this.activeContracts=0,this.activeRoles=0;var s=function(){i.get().then(function(t){return angular.forEach(t,function(t){n.call(a,t),"1"===t.is_current&&a.activeContracts++}),c.get()}).then(function(e){angular.forEach(e,function(e){var n=t(e.end_date);(!n.isValid()||r(n))&&a.activeRoles++})})["finally"](function(){a.ready=!0})}.bind(this),u=function(){this.dates=[],s()}.bind(this);s(),o.subscribe("contract-refresh",u)}e.controller("KeyDatesCtrl",["$log","ContractService","JobRoleService","pubSub",i])}),define("contact-summary/controllers/keyDetails",["common/moment","contact-summary/modules/controllers","contact-summary/services/contactDetails","contact-summary/services/contract","common/services/pub-sub"],function(t,e){"use strict";function n(t,e,n,r){t.debug("Controller: KeyDetailsCtrl"),this.ready=!1;var i=function(){e.get().then(function(t){return this.contactDetails=t,n.getPrimary()}.bind(this)).then(function(t){return _.isEmpty(t)?void(this.primaryContract=null):void(this.primaryContract=t)}.bind(this)).then(function(t){return n.getLengthOfService()}).then(function(t){this.lengthOfService=t}.bind(this))["finally"](function(){this.ready=!0}.bind(this))}.bind(this),c=function(){n.resetContracts(),e.data.item={},i()};i(),r.subscribe("contract-refresh",c)}e.controller("KeyDetailsCtrl",["$log","ContactDetailsService","ContractService","pubSub",n])}),define("contact-summary/controllers/leave",["common/d3","contact-summary/modules/controllers","contact-summary/services/leave"],function(t,e){"use strict";function n(e,n){e.debug("Controller: LeaveCtrl");var r=this;this.leaves=[],this.toil={},this.totalEntitlement=0,this.totalTaken=0,this.ready=!1,this.chartColors=t.scale.category20(),n.getCurrent().then(function(t){angular.forEach(t,function(t){"Sick"!==t.title&&("TOIL"===t.title?r.toil=t:(r.totalEntitlement+=t.entitled,r.totalTaken+=t.taken,r.leaves.push(t)))})})["finally"](function(){r.ready=!0})}e.controller("LeaveCtrl",["$log","LeaveService",n])}),define("contact-summary/controllers/sickness",["contact-summary/modules/controllers","contact-summary/services/leave"],function(t){"use strict";function e(t,e){t.debug("Controller: SicknessCtrl");var n=this;this.taken=0,this.takenPreviously=0,this.staffAverage=0,this.ready=!1,this.currentPeriod="-",e.getStaffAverage("sick").then(function(t){return n.staffAverage=t,e.getCurrent()}).then(function(t){return angular.forEach(t,function(t){"Sick"===t.title&&(n.taken=t.taken)}),e.getPrevious()}).then(function(t){return angular.forEach(t,function(t){"Sick"===t.title&&(n.takenPreviously=t.taken)}),e.getCurrentPeriod()}).then(function(t){n.currentPeriod=t.title})["finally"](function(){n.ready=!0})}t.controller("SicknessCtrl",["$log","LeaveService",e])}),define("contact-summary/modules/directives",["common/angular"],function(t){"use strict";return t.module("contactsummary.directives",[])}),define("contact-summary/directives/donutChart",["common/d3","contact-summary/modules/directives"],function(t,e){"use strict";function n(t){this.height=this.width=t[0].clientWidth,this.radius=this.width/2||60,this.thickness=this.thickness||15}function r(){return t.svg.arc().innerRadius(this.radius-this.thickness).outerRadius(this.radius)}function i(e,n,r){var i=t.scale.category20();return e.selectAll("path").data(r).enter().append("path").attr("fill",function(t,e){return i(e)}).attr("class",function(t,e){return"chart-color-"+e}).attr("d",n)}function c(){var e=t.layout.pie().sort(null).value(function(t){return t.value[this.itemKey]}.bind(this));return e(t.entries(this.items))}function o(e){return t.select(e).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.width/2+","+this.height/2+")")}e.directive("csDonutChart",["$log",function(t){return t.debug("Directive: csDonutChart"),{controllerAs:"CsDonutChartCtrl",restrict:"AE",scope:{radius:"@",thickness:"@",items:"=",itemKey:"@",ready:"="},controller:["$scope","$element",function(t,e){this.drawChart=function(){n.call(angular.extend(this,t),e),i(o.call(this,e[0]),r.call(this),c.call(this))}}],link:function(t,e,n,r){var i=t.$watch(function(){return t.ready},function(t,e){t===!0&&(r.drawChart(),i())})}}}])}),define("contact-summary/app",["common/angular","contact-summary/modules/filters","contact-summary/modules/services","contact-summary/modules/settings","contact-summary/controllers/contactSummary","contact-summary/controllers/keyDates","contact-summary/controllers/keyDetails","contact-summary/controllers/leave","contact-summary/controllers/sickness","contact-summary/directives/donutChart"],function(t){var e=t.module("contactsummary",["ngRoute","ngResource","ui.bootstrap","common.services","contactsummary.controllers","contactsummary.directives","contactsummary.filters","contactsummary.services","contactsummary.settings"]);e.config(["settings","$routeProvider","$resourceProvider","$httpProvider","$logProvider",function(t,e,n,r,i){i.debugEnabled(t.debug),e.when("/",{controller:"ContactSummaryCtrl",controllerAs:"ContactSummaryCtrl",templateUrl:t.pathBaseUrl+t.pathTpl+"mainTemplate.html",resolve:{}}).otherwise({redirectTo:"/"}),n.defaults.stripTrailingSlashes=!1,r.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),e.run(["settings","$rootScope","$q","$log",function(t,e,n,r){r.debug("app.run"),e.pathTpl=t.pathTpl,e.prefix=t.classNamePrefix}])}),function(t,e){e.config({urlArgs:"bust="+(new Date).getTime(),paths:{"contact-summary":t.vars.contactsummary.baseURL+"/js/src/contact-summary"}}),e(["contact-summary/app"],function(){document.dispatchEvent("function"==typeof window.CustomEvent?new CustomEvent("contactsummaryReady"):function(){var t=document.createEvent("Event");return t.initEvent("contactsummaryReady",!0,!0),t}())})}(CRM,require);