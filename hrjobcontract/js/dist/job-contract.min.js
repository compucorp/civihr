/*
fraction.js
A Javascript fraction library.

Copyright (c) 2009  Erik Garrison <erik@hypervolu.me>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/

// Copyright CiviCRM LLC 2013. See http://civicrm.org/licensing

define("job-contract/controllers/controllers",["common/angular"],function(e){"use strict";return e.module("hrjc.controllers",[])}),define("job-contract/filters/filters",["common/angular"],function(e){"use strict";return e.module("hrjc.filters",[])}),define("job-contract/filters/get-obj-by-id",["job-contract/filters/filters"],function(e){"use strict";e.filter("getObjById",["$log",function(e){return e.debug("Filter: getObjById"),function(e,t,n){if(!e)return null;for(var r=0,o=e.length;r<o;r++)if(+e[r].id==+t)return n?e[r][n]:e[r];return null}}])}),define("job-contract/services/services",["common/angular"],function(e){"use strict";return e.module("hrjc.services",[])}),define("job-contract/services/utils",["job-contract/services/services"],function(e){"use strict";e.factory("API",["$resource","$q","settings","$log",function(e,t,n,r){return r.debug("Service: UtilsService"),{resource:function(t,r,o){return!t||"string"!=typeof t||!r||"string"!=typeof r||o&&"object"!=typeof o?null:e(n.pathRest,{action:r,entity:t,json:o})},getOne:function(e,n){if(!e||"string"!=typeof e||n&&"object"!=typeof n)return null;var r,o=t.defer(),i=angular.extend({sequential:1},n);return this.resource(e,"get",i).get(function(e){r=e.values,o.resolve(1==r.length?r[0]:null)},function(){o.reject("Unable to fetch data")}),o.promise},get:function(e,n){if(!e||"string"!=typeof e||n&&"object"!=typeof n)return null;var r=t.defer(),o=angular.extend({sequential:1},n);return this.resource(e,"get",o).get(function(e){r.resolve(e.values)},function(){r.reject("Unable to fetch data")}),r.promise}}}]),e.factory("testAPI",["$resource","settings",function(e,t){return{resource:function(n,r,o){return!n||"string"!=typeof n||!r||"string"!=typeof r||o&&"object"!=typeof o?null:e(t.pathApp+"js/data/"+n+".json",{action:r,entity:n,json:o})}}}]),e.factory("UtilsService",["API","testAPI","settings","$q","$log","$timeout",function(e,t,n,r,o,i){return{getAbsenceType:function(){var t=r.defer();return e.resource("HRAbsenceType","get",{return:"id,name,title"}).get(function(e){t.resolve(e.values)},function(){t.reject("Unable to fetch absence types")}),t.promise},getHoursLocation:function(){var t=r.defer();return e.resource("HRHoursLocation","get",{sequential:1,is_active:1}).get(function(e){t.resolve(e.values)},function(){t.reject("Unable to fetch standard hours")}),t.promise},getPayScaleGrade:function(){var t=r.defer();return e.resource("HRPayScale","get",{sequential:1,is_active:1}).get(function(e){t.resolve(e.values)},function(){t.reject("Unable to fetch standard hours")}),t.promise},prepareEntityIds:function(e,t,n){function r(e){e.jobcontract_id=t,delete e.id,n?e.jobcontract_revision_id=n:delete e.jobcontract_revision_id}if(angular.isArray(e)){var o=0,i=e.length;for(o;o<i;o++)r(e[o])}else if(angular.isObject(e))return void r(e)},errorHandler:function(e,t,n){return e.is_error?(o.error(e.error_code+"\n"+e.error_message),n&&n.reject(e.error_code+"\n"+e.error_message),e.trace&&o.error(e.trace),!0):e.values?void 0:(o.error(t||"Unknown Error"),n&&n.reject(t||"Unknown Error"),!0)}}}])}),define("job-contract/services/contract-details",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractDetailsService",["$filter","$resource","settings","$q","UtilsService","$log",function(e,t,n,r,o,i){function a(t){var n=e("formatDate")(t,"YYYY-MM-DD");return"Unspecified"!==n?n:t}i.debug("Service: ContractDetailsService");var c=t(n.pathRest,{action:"get",entity:"HRJobDetails",json:{}});return{validateDates:function(e){if(!e||"object"!=typeof e||!e.contact_id||!e.period_start_date)return null;e.period_start_date=a(e.period_start_date),e.period_end_date=a(e.period_end_date),e.sequential=0,e.debug=n.debug;var t,i=r.defer();return c.save({action:"validatedates",json:e},null,function(e){o.errorHandler(e,'Unable to fetch API "validatedates" response',i)||(t=e.values,i.resolve(t))}),i.promise},getOne:function(e){if(!e||"object"!=typeof e||!e.jobcontract_id&&!e.jobcontract_revision_id||e.jobcontract_id&&"number"!=typeof+e.jobcontract_id||e.jobcontract_revision_id&&"number"!=typeof+e.jobcontract_revision_id)return null;e.sequential=1,e.debug=n.debug;var t,i=r.defer();return c.get({json:e},function(e){o.errorHandler(e,"Unable to fetch contract details",i)||(t=e.values,i.resolve(1==t.length?t[0]:null))},function(){i.reject("Unable to fetch contract details")}),i.promise},getOptions:function(e,t){var o,i=r.defer();return t||(o=n.CRM.options.HRJobDetails||{},e&&"string"==typeof e&&(o=o[e]),i.resolve(o||{})),i.promise},getFields:function(e){if(e&&"object"!=typeof e)return null;e&&"object"==typeof e||(e={});var t=r.defer(),o=n.CRM.fields;return o&&o.HRJobDetails?t.resolve(o.HRJobDetails):(e.sequential=1,c.get({action:"getfields",json:e},function(e){e.values||t.reject("Unable to fetch contract details fields"),t.resolve(e.values)},function(){t.reject("Unable to fetch contract details fields")})),t.promise},save:function(e){if(!e||"object"!=typeof e)return null;e.period_start_date=a(e.period_start_date),e.period_end_date=a(e.period_end_date);var t,i=r.defer(),s=angular.extend({sequential:1,debug:n.debug},e);return c.save({action:"create",json:s},null,function(e){o.errorHandler(e,"Unable to create contract details",i)||(t=e.values,i.resolve(1==t.length?t[0]:null))},function(){i.reject("Unable to create contract details")}),i.promise},model:function(e){function t(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return"undefined"!=typeof r.id&&(r.id=null),"undefined"!=typeof r.jobcontract_revision_id&&(r.jobcontract_revision_id=null),"undefined"!=typeof r.location&&(r.location=null),r}var n=r.defer();return e?n.resolve(t(e)):this.getFields().then(function(e){n.resolve(t(e))}),n.promise}}}])}),define("job-contract/services/contract-hour",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractHourService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,o){o.debug("Service: ContractHourService");var i=e(t.pathRest,{action:"get",entity:"HRJobHour",json:{}});return{getOne:function(e){if(!e||"object"!=typeof e||!e.jobcontract_revision_id||e.jobcontract_revision_id&&"number"!=typeof+e.jobcontract_revision_id)return null;e.sequential=1,e.debug=t.debug;var o,a=n.defer();return i.get({json:e},function(e){r.errorHandler(e,"Unable to fetch contract hours",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to fetch contract hours")}),a.promise},getOptions:function(e,r){var o,i=n.defer();if(!r){var o=t.CRM.options.HRJobHour||{};e&&"string"==typeof e&&(o=o[e]),i.resolve(o||{})}return i.promise},getFields:function(e){if(e&&"object"!=typeof e)return null;e&&"object"==typeof e||(e={});var r=n.defer(),o=t.CRM.fields;return o&&o.HRJobHour?r.resolve(o.HRJobHour):(e.sequential=1,i.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract hours fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract hours fields")})),r.promise},save:function(e){if(!e||"object"!=typeof e)return null;var o,a=n.defer(),c=angular.extend({sequential:1,debug:t.debug},e);return i.save({action:"create",json:c},null,function(e){r.errorHandler(e,"Unable to create contract hours",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to create contract hours")}),a.promise},model:function(e){function t(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return"undefined"!=typeof r.id&&(r.id=null),"undefined"!=typeof r.jobcontract_revision_id&&(r.jobcontract_revision_id=null),r}var r=n.defer();return e?r.resolve(t(e)):this.getFields().then(function(e){r.resolve(t(e))}),r.promise}}}])}),define("job-contract/services/contract-health",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractHealthService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,o){o.debug("Service: ContractHealthService");var i=e(t.pathRest,{action:"get",entity:"HRJobHealth",json:{}});return{getOne:function(e){if(!e||"object"!=typeof e||!e.jobcontract_revision_id||e.jobcontract_revision_id&&"number"!=typeof+e.jobcontract_revision_id)return null;e.sequential=1,e.debug=t.debug;var o,a=n.defer();return i.get({json:e},function(e){r.errorHandler(e,"Unable to fetch contract Health",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to fetch contract Health")}),a.promise},getOptions:function(e,r){var o,i=n.defer();if(!r){var o=t.CRM.options.HRJobHealth||{};e&&"string"==typeof e&&(o=o[e]),i.resolve(o||{})}return i.promise},getFields:function(e){if(e&&"object"!=typeof e)return null;e&&"object"==typeof e||(e={});var r=n.defer(),o=t.CRM.fields;return o&&o.HRJobHealth?r.resolve(o.HRJobHealth):(e.sequential=1,i.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract insurance fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract insurance fields")})),r.promise},save:function(e){if(!e||"object"!=typeof e)return null;var o,a=n.defer(),c=angular.extend({sequential:1,debug:t.debug},e);return i.save({action:"create",json:c},null,function(e){r.errorHandler(e,"Unable to create contract insurance",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to create contract insurance")}),a.promise},model:function(e){function t(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return"undefined"!=typeof r.id&&(r.id=null),"undefined"!=typeof r.jobcontract_revision_id&&(r.jobcontract_revision_id=null),r}var r=n.defer();return e?r.resolve(t(e)):this.getFields().then(function(e){r.resolve(t(e))}),r.promise}}}])}),define("job-contract/services/contract-leave",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractLeaveService",["$resource","$q","settings","UtilsService","$log",function(e,t,n,r,o){o.debug("Service: ContractLeaveService");var i=e(n.pathRest,{action:"get",entity:"HRJobLeave",json:{}});return{getOne:function(e){if(!e||"object"!=typeof e||!e.jobcontract_revision_id||e.jobcontract_revision_id&&"number"!=typeof+e.jobcontract_revision_id||e.id&&"number"!=typeof+e.id||e.leaveType&&"number"!=typeof+e.leaveType)return null;e.sequential=1,e.debug=n.debug;var o=t.defer();return i.get({json:e},function(e){r.errorHandler(e,"Unable to fetch contract leave",o)||o.resolve(e.values)},function(){o.reject("Unable to fetch contract leave")}),o.promise},getOptions:function(e,r){var o,i=t.defer();if(!r){var o=n.CRM.options.HRJobLeave||{};e&&"string"==typeof e&&(o=o[e]),i.resolve(o||{})}return i.promise},getFields:function(e){if(e&&"object"!=typeof e)return null;e&&"object"==typeof e||(e={});var r=t.defer(),o=n.CRM.fields;return o&&o.HRJobLeave?r.resolve(o.HRJobLeave):(e.sequential=1,i.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract leave fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract leave fields")})),r.promise},save:function(e){if(!e||"object"!=typeof e)return null;var o=t.defer(),a={sequential:1,values:e,debug:n.debug};return i.save({action:"replace",json:a},null,function(e){r.errorHandler(e,"Unable to create contract leave",o)||o.resolve(e.values)},function(){o.reject("Unable to create contract details")}),o.promise},model:function(e,n){function r(e,t){var n=0,r=t.length,o=[],i={};for(n;n<r;n++)i[t[n].name]="";return"undefined"!=typeof i.id&&(i.id=null),"undefined"!=typeof i.jobcontract_revision_id&&(i.jobcontract_revision_id=null),"undefined"!=typeof i.location&&(i.location=null),e&&"object"==typeof e&&i&&"object"==typeof i&&"undefined"!=typeof i.leave_type?(angular.forEach(e,function(e,t){i.leave_type=t,i.leave_amount=0,o.push(angular.copy(i))}),o):null}var o=t.defer(),i=n&&"object"==typeof n?n:this.getOptions("leave_type");return e?t.when(i).then(function(t){o.resolve(r(t,e))}):this.getFields().then(function(e){t.when(i).then(function(t){o.resolve(r(t,e))})}.bind(this)),o.promise}}}])}),define("job-contract/services/contract-pay",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractPayService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,o){o.debug("Service: ContractPayService");var i=e(t.pathRest,{action:"get",entity:"HRJobPay",json:{}});return{getOne:function(e){if(!e||"object"!=typeof e||!e.jobcontract_revision_id||e.jobcontract_revision_id&&"number"!=typeof+e.jobcontract_revision_id)return null;e.sequential=1,e.debug=t.debug;var o,a=n.defer();return i.get({json:e},function(e){r.errorHandler(e,"Unable to fetch contract pay",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to fetch contract pay")}),a.promise},getOptions:function(e,r){var o,i=n.defer();if(!r){var o=t.CRM.options.HRJobPay||{};e&&"string"==typeof e&&(o=o[optionGroup]),i.resolve(o||{})}return i.promise},getFields:function(e){if(e&&"object"!=typeof e)return null;e&&"object"==typeof e||(e={});var r=n.defer(),o=t.CRM.fields;return o&&o.HRJobPay?r.resolve(o.HRJobPay):(e.sequential=1,i.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract pay fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract pay fields")})),r.promise},save:function(e){if(!e||"object"!=typeof e)return null;var o,a=n.defer(),c=angular.extend({sequential:1,debug:t.debug},e);return i.save({action:"create",json:c},null,function(e){r.errorHandler(e,"Unable to create contract pay",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to create contract pay")}),a.promise},model:function(e){function t(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return"undefined"!=typeof r.id&&(r.id=null),"undefined"!=typeof r.jobcontract_revision_id&&(r.jobcontract_revision_id=null),"undefined"!=typeof r.annual_benefits&&(r.annual_benefits=[]),"undefined"!=typeof r.annual_deductions&&(r.annual_deductions=[]),r}var r=n.defer();return e?r.resolve(t(e)):this.getFields().then(function(e){r.resolve(t(e))}),r.promise}}}])}),define("job-contract/services/contract-pension",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractPensionService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,o){o.debug("Service: ContractPensionService");var i=e(t.pathRest,{action:"get",entity:"HRJobPension",json:{}});return{getOne:function(e){if(!e||"object"!=typeof e||!e.jobcontract_revision_id||e.jobcontract_revision_id&&"number"!=typeof+e.jobcontract_revision_id)return null;e.sequential=1,e.debug=t.debug;var o,a=n.defer();return i.get({json:e},function(e){r.errorHandler(e,"Unable to fetch contract pension",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to fetch contract pension")}),a.promise},getOptions:function(e,r){var o,i=n.defer();if(!r){var o=t.CRM.options.HRJobPension||{};e&&"string"==typeof e&&(o=o[optionGroup]),i.resolve(o||{})}return i.promise},getFields:function(e){if(e&&"object"!=typeof e)return null;e&&"object"==typeof e||(e={});var r=n.defer(),o=t.CRM.fields;return o&&o.HRJobPension?r.resolve(o.HRJobPension):(e.sequential=1,i.get({action:"getfields",json:e},function(e){e.values||r.reject("Unable to fetch contract pension fields"),r.resolve(e.values)},function(){r.reject("Unable to fetch contract pension fields")})),r.promise},save:function(e){if(!e||"object"!=typeof e)return null;var o,a=n.defer(),c=angular.extend({sequential:1,debug:t.debug},e);return i.save({action:"create",json:c},null,function(e){r.errorHandler(e,"Unable to create contract pension",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to create contract pension")}),a.promise},model:function(e){function t(e){var t=0,n=e.length,r={};for(t;t<n;t++)r[e[t].name]="";return"undefined"!=typeof r.id&&(r.id=null),"undefined"!=typeof r.jobcontract_revision_id&&(r.jobcontract_revision_id=null),r}var r=n.defer();return e?r.resolve(t(e)):this.getFields().then(function(e){r.resolve(t(e))}),r.promise}}}])}),define("job-contract/controllers/contract-list",["job-contract/controllers/controllers","job-contract/filters/get-obj-by-id","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-health","job-contract/services/contract-leave","job-contract/services/contract-pay","job-contract/services/contract-pension","job-contract/services/utils","common/services/pub-sub"],function(e){"use strict";e.controller("ContractListCtrl",["$scope","$rootElement","$rootScope","$uibModal","$q","$filter","$sce","contractList","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","UtilsService","settings","$log","pubSub",function(e,t,n,r,o,i,a,c,s,l,u,d,f,v,p,h,m,_,b){_.debug("Controller: ContractListCtrl");var y,g={details:l,hour:u,pay:d,leave:f,health:v,pension:p},j={hoursLocation:h.getHoursLocation(),payScaleGrade:h.getPayScaleGrade()},C={},$={};e.contractListLoaded=!1,e.contractCurrent=[],e.contractPast=[],e.utils={contractListLen:c.length},e.tooltips={changeContractTerms:a.trustAsHtml('<div><p class="text-left"><strong>Change Contract Terms:</strong><br>When an employeees job or role changes, i.e. promotion, secondment or move,you can use this wizard to update the details of the contract and record a newrevision of the contract. A contract history is kept so you can always see theprevious version of the contract.</p><p class="text-left"><strong>Correct an error on the contract record:</strong><br>If you notice an issue or error with the job terms you can correct these withoutcreating a new job history record. These changes are not stored as a new revisionof the contract.</p></div>')};for(y in g)C[y]=g[y].getFields();o.all(C).then(function(t){e.fields=t,_.debug("FIELDS:"),_.debug(t);for(y in g)$[y]=g[y].model(t[y]);return o.all($)}).then(function(t){e.model=t,_.debug("MODEL:"),_.debug(t),c=i("orderBy")(c,"-is_primary"),angular.forEach(c,function(t){+t.is_current?e.contractCurrent.push(t):e.contractPast.push(t)}),e.$watchCollection("contractCurrent",function(){e.utils.contractListLen=e.contractCurrent.length+e.contractPast.length}),e.$watchCollection("contractPast",function(){e.utils.contractListLen=e.contractCurrent.length+e.contractPast.length}),n.$broadcast("hrjc-loader-hide"),e.contractListLoaded=!0}),o.all(j).then(function(t){angular.extend(e.utils,t)}),e.toggleIsPrimary=function(t){function n(e){var n=0,r=e.length;for(n;n<r;n++)if(+e[n].id!=+t&&+e[n].is_primary)return e[n].is_primary="0",e[n].id;return null}n(e.contractCurrent)||n(e.contractPast),(i("getObjById")(e.contractCurrent,t)||i("getObjById")(e.contractPast,t)||{}).is_primary="1",e.contractCurrent=i("orderBy")(e.contractCurrent,"-is_primary"),e.contractPast=i("orderBy")(e.contractPast,"-is_primary")},e.modalContract=function(n){if(!n||"new"!==n)return null;var i,a={appendTo:t.find("div").eq(0),templateUrl:m.pathApp+"views/modalForm.html?v=2222",size:"lg",controller:"ModalContractNewCtrl",windowClass:"modal-contract",resolve:{model:function(){return e.model},utils:function(){return o.all(angular.extend(j,{contractListLen:e.utils.contractListLen}))}}};i=r.open(a),i.result.then(function(t){s.updateHeaderInfo(),+t.is_current?e.contractCurrent.push(t):e.contractPast.push(t),+t.is_primary&&e.toggleIsPrimary(t.id)})},e.delete=function(n){function o(t,n){var r=0,o=t.length;for(r;r<o;r++)if(+t[r].id==n)return e.$emit("hrjc-loader-hide"),t.splice(r,1),n;return null}var i=r.open({appendTo:t.find("div").eq(0),templateUrl:m.pathApp+"views/modalDialog.html",size:"sm",controller:"ModalDialogCtrl",resolve:{content:function(){return{msg:"Are you sure you want to delete this job contract?"}}}});i.result.then(function(t){t&&(e.$emit("hrjc-loader-show"),s.delete(n).then(function(t){t.is_error||(s.updateHeaderInfo(),o(e.contractCurrent,n)||o(e.contractPast,n),b.publish("contract:deleted",{contactId:m.contactId,contractId:n}),b.publish("contract-refresh"))}))})}}])}),define("job-contract/services/contact",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContactService",["$resource","settings","$q","UtilsService","$log",function(e,t,n,r,o){o.debug("Service: ContactService");var i=e(t.pathRest,{action:"getlist",entity:"contact",json:{}});return{getOne:function(e){if(!e||"number"!=typeof+e)return null;var o,a=n.defer();return i.get({json:{id:e,debug:t.debug}},function(e){r.errorHandler(e,"Unable to fetch contact",a)||(o=e.values,a.resolve(1==o.length?o[0]:null))},function(){a.reject("Unable to fetch contact")}),a.promise},search:function(e,o){if(!e||"undefined"==typeof e||o&&"object"!=typeof o)return null;var a=n.defer(),o=o||{};return i.get({json:{input:e,params:o,debug:t.debug}},function(e){r.errorHandler(e,"Unable to fetch contact list",a)||a.resolve(e.values)},function(){a.reject("Unable to fetch contact list")}),a.promise}}}])}),define("job-contract/controllers/contract",["common/moment","job-contract/controllers/controllers","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-pay","job-contract/services/contract-leave","job-contract/services/contract-pension","job-contract/services/contract-health","job-contract/services/contact","job-contract/services/utils","common/filters/angular-date/format-date"],function(e,t){"use strict";t.controller("ContractCtrl",["$scope","$route","$filter","$uibModal","$rootElement","$q","settings","API","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","ContractFilesService","ContactService","ContractRevisionList","$log",function(t,n,r,o,i,a,c,s,l,u,d,f,v,p,h,m,_,b,y){function g(e){var n={id:null,jobcontract_id:S,jobcontract_revision_id:e.details.jobcontract_revision_id};angular.extend(t.details,e.details),angular.extend(t.hour,e.hour||n),angular.extend(t.pay,e.pay||n),e.health&&e.health.provider&&e.health.provider!=t.health.provider&&_.getOne(e.health.provider).then(function(e){t.health.provider_contact=e}),e.health&&e.health.provider_life_insurance&&e.health.provider_life_insurance!=t.health.provider_life_insurance&&_.getOne(e.health.provider_life_insurance).then(function(e){t.health.provider_life_insurance_contact=e}),angular.extend(t.health,e.health||n),angular.extend(t.pension,e.pension||n),angular.forEach(t.leave,function(t,r){angular.extend(t,e.leave?e.leave[r]||n:n)})}function j(n){var r=!n||e().diff(n,"day")<=0;r?(t.$parent.contract.is_current="1",t.$parent.contractCurrent.push(t.$parent.contract),t.$parent.contractPast.splice(t.$parent.contractPast.indexOf(t.$parent.contract),1)):(t.$parent.contract.is_current="0",t.$parent.contractPast.push(t.$parent.contract),t.$parent.contractCurrent.splice(t.$parent.contractCurrent.indexOf(t.$parent.contract),1))}function C(){return $=a.all({details:m.get(t.details.jobcontract_revision_id,"civicrm_hrjobcontract_details"),pension:m.get(t.pension.jobcontract_revision_id,"civicrm_hrjobcontract_pension")}),$.then(function(e){t.files=e}),$}y.debug("Controller: ContractCtrl");var $,w=this,S=t.contract.id;t.contractLoaded=!1,t.revisionsShown=!1,t.isCollapsed=!0,t.files={},t.revisionCurrent={},t.revisionList=[],t.revisionDataList=[],angular.extend(t,angular.copy(t.model)),l.fullDetails(S).then(function(e){g(e),t.contractLoaded=!0,t.$watch("contract.is_primary",function(){t.isCollapsed=!+t.contract.is_primary}),t.$broadcast("hrjc-loader-show"),b.fetchRevisions(S).then(function(e){t.revisionList=e.revisionList,t.revisionDataList=e.revisionDataList,t.$broadcast("hrjc-loader-hide")})}).then(C),w.fetchRevisionDetails=function(e){return a.all([u.getOne({jobcontract_revision_id:e.details_revision_id}),d.getOne({jobcontract_revision_id:e.hour_revision_id}),p.getOne({jobcontract_revision_id:e.health_revision_id}),f.getOne({jobcontract_revision_id:e.pay_revision_id}),h.getOne({jobcontract_revision_id:e.pension_revision_id}),v.getOne({jobcontract_revision_id:e.leave_revision_id})]).then(function(e){var n={details:e[0],hour:e[1],health:e[2],pay:e[3],pension:e[4],leave:e[5]},r={contract:t.contract};return angular.extend(r,angular.copy(t.model)),angular.extend(r.details,n.details),angular.extend(r.hour,n.hour),angular.extend(r.health,n.health),angular.extend(r.pay,n.pay),angular.extend(r.pension,n.pension),angular.forEach(r.leave,function(e,t){angular.extend(e,n.leave?n.leave[t]:"")}),r})},t.modalContract=function(n,r){t.$broadcast("hrjc-loader-show");var s,u={controller:"ModalContractCtrl",appendTo:i.find("div").eq(0),templateUrl:c.pathApp+"views/modalForm.html?v=4448",windowClass:"modal-contract",size:"lg",resolve:{action:function(){return n||"view"},content:function(){return null},entity:function(){return r?w.fetchRevisionDetails(r):{contract:t.contract,details:t.details,hour:t.hour,pay:t.pay,leave:t.leave,health:t.health,pension:t.pension}},files:function(){return r?a.all({details:m.get(r.details_revision_id,"civicrm_hrjobcontract_details"),pension:m.get(r.pension_revision_id,"civicrm_hrjobcontract_pension")}):$},utils:function(){return t.utils}}};switch(n){case"edit":u.resolve.content=function(){return{allowSave:!0,isDisabled:!1,copy:{close:"Cancel",save:"Save without making a new revision",title:"Edit contract"}}};break;case"change":u.resolve.content=function(){return{allowSave:!0,isDisabled:!1,copy:{close:"Cancel",save:"Save and make a new revision",title:"Change contract terms"}}}}s=o.open(u),s.result.then(function(n){if(n){if(l.updateHeaderInfo(),g(n),j(n.details.period_end_date),n.revisionCreated){var r=e(new Date(n.revisionCreated.effective_date)),o=e(new Date(t.revisionCurrent.effective_date)),i=e(),c={revisionEntityIdObj:n.revisionCreated,details:n.details,hour:n.hour,pay:n.pay},s=o.diff(i,"day")<=0||o.diff(r,"day")<=0;n.files&&(s?C().then(function(e){c.files=e}):a.all({details:m.get(n.revisionCreated.details_revision_id,"civicrm_hrjobcontract_details")}).then(function(e){c.files=e})),t.revisionList.unshift(n.revisionCreated),t.revisionDataList.unshift(c)}else{var u,d,f=["details","hour","pay"];t.contract.is_primary!=n.contract.is_primary&&t.$parent.$parent.toggleIsPrimary(t.contract.id),angular.forEach(t.revisionDataList,function(e){for(u=0,d={};f[u];)e.revisionEntityIdObj[f[u]+"_revision_id"]==t.revisionCurrent[f[u]+"_revision_id"]&&(d[f[u]]=n[f[u]],"details"==f[u]&&n.files&&C().then(function(t){d.files=t,angular.extend(e,d)}),angular.extend(e,d)),u++})}CRM.refreshParent("#hrjobroles")}})},t.showRevisions=function(){t.revisionsShown=!0},t.modalRevision=function(e){if(t.$broadcast("hrjc-loader-show"),!e)return null;var n=[],l="leave"!=e?"getOne":"get",u=0,d=t.revisionList.length;for(u;u<d;u++)n.push(s[l]("HRJob"+r("capitalize")(e),{jobcontract_revision_id:t.revisionList[u][e+"_revision_id"]}));var f={appendTo:i.find("div").eq(0),size:"lg",controller:"ModalRevisionCtrl",templateUrl:c.pathApp+"views/modalRevision.html?v=1234",windowClass:"modal-revision",resolve:{entity:function(){return e},fields:function(){return t.$parent.$parent.fields[e]},model:function(){return t.model[e]},utils:function(){return t.utils},revisionDataList:function(){return a.all(n)},revisionList:function(){return t.revisionList},modalContract:function(){return t.modalContract}}};return o.open(f)},t.$on("updateContractView",function(){t.$broadcast("hrjc-loader-show"),l.fullDetails(t.revisionCurrent.jobcontract_id).then(function(e){g(e),t.$broadcast("hrjc-loader-hide")}).then(C)})}])}),define("job-contract/services/contract",["job-contract/services/services"],function(e){"use strict";e.factory("Contract",["$resource","settings","$log",function(e,t,n){return n.debug("Service: Contract"),e(t.pathRest,{action:"get",entity:"HRJobContract",json:{}})}]),e.factory("ContractService",["$log","$q","Contract","ContractRevisionService","settings","UtilsService","DOMEventTrigger",function(e,t,n,r,o,i,a){return e.debug("Service: ContractService"),{get:function(e){var r=t.defer(),a={};return CRM&&CRM.jobContractTabApp&&CRM.jobContractTabApp.contractList?r.resolve(CRM.jobContractTabApp.contractList):(a={sequential:1,contact_id:o.contactId,deleted:0},e&&"number"==typeof+e&&(a.contact_id=e),n.get({json:a},function(e){i.errorHandler(e,"Unable to fetch contract list",r)||r.resolve(e.values)},function(){r.reject("Unable to fetch contract list")})),r.promise},getCurrentContract:function(e){var r=t.defer();return n.get({action:"getcurrentcontract",json:{contact_id:e}},function(e){e.is_error&&r.reject("Unable to fetch the current contract"),r.resolve(e.values)},function(){r.reject("Unable to fetch the current contract")}),r.promise},updateHeaderInfo:function(){this.getCurrentContract(o.contactId).then(function(e){a("updateContactHeader",{contract:e})}).catch(function(e){console.log(e)})},getOne:function(e,r){if(!e||"number"!=typeof+e)return null;var i,a=t.defer(),c={deleted:0,sequential:1,contact_id:o.contactId,id:e};return r&&"number"==typeof+r&&(c.contact_id=r),n.get({json:c},function(e){i=e.values,a.resolve(1==i.length?i[0]:null)},function(){a.reject("Unable to fetch contract data")}),a.promise},getRevision:function(e){if(!e||"number"!=typeof+e)return null;var n=t.defer(),o={deleted:0,options:{limit:0},sequential:1,jobcontract_id:e};return r.get({json:o},function(e){n.resolve(e.values)},function(){n.reject("Unable to fetch contract revisions")}),n.promise},getRevisionOptions:function(e,n){var r,i=t.defer();if(!n){var r=o.CRM.options.HRJobContractRevision||{};e&&"string"==typeof e&&(r=r[optionGroup]),i.resolve(r||{})}return i.promise},save:function(e){if(!e||"object"!=typeof e||!e.id||"number"!=typeof+e.id)return null;var r,o=t.defer(),i=angular.extend({deleted:0,sequential:1},e);return n.save({action:"create",json:i},null,function(e){r=e.values,o.resolve(1==r.length?r[0]:null)},function(){o.reject("Unable to fetch contract contract data")}),o.promise},saveRevision:function(e){if(!e||"object"!=typeof e||!e.id||"number"!=typeof+e.id)return null;var n,o=t.defer(),i=angular.extend({deleted:0,sequential:1},e);return r.save({action:"create",json:i},null,function(e){n=e.values,o.resolve(1==n.length?n[0]:null)},function(){o.reject("Unable to fetch contract revision")}),o.promise},delete:function(e){if(!e||"number"!=typeof+e)return null;var r=t.defer();return n.delete({action:"deletecontract",json:{id:e}},function(e){r.resolve(e)},function(){r.reject("Could not delete contract ID:"+e)}),r.promise},deleteRevision:function(e){if(!e||"number"!=typeof+e)return null;var n,o=t.defer();return r.save({action:"create",json:{sequential:1,deleted:1,id:e}},null,function(e){n=e.values,o.resolve(1==n.length?n[0]:null)},function(){o.reject("Unable to delete contract revision id: "+e)}),o.promise},fullDetails:function(e){if(!e||"number"!=typeof+e)return null;var r=t.defer();return n.get({action:"getfulldetails",json:{jobcontract_id:e}},function(e){r.resolve(e)},function(){r.reject("Could not fetch full details for contract ID:"+e)}),r.promise}}}])}),define("job-contract/controllers/revision-list",["common/lodash","job-contract/controllers/controllers","job-contract/services/contract"],function(e,t){"use strict";t.controller("RevisionListCtrl",["$scope","$filter","$q","$uibModal","$rootElement","settings","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractFilesService","$log","ContractRevisionService","ContractRevisionList",function(e,t,n,r,o,i,a,c,s,l,u,d,f,v){function p(){e.revisionDataList||(e.$broadcast("hrjc-loader-show"),v.fetchRevisions(_).then(function(t){e.revisionList=t.revisionList,e.revisionDataList=t.revisionDataList,e.$broadcast("hrjc-loader-hide")}))}function h(){var n,r=0;if(e.revisionList.length){var o=t("orderBy")(e.revisionList,["effective_date","id"]);if(angular.forEach(o,function(e){new Date(e.effective_date).setHours(0,0,0,0)<=(new Date).setHours(0,0,0,0)&&(n=e);
}),!n)do n=o[r],r++;while(o[r]&&o[r-1].effective_date==o[r].effective_date);return angular.extend(e.revisionCurrent,n),n.id}return null}function m(){var t=i.pathReport+(i.pathReport.indexOf("?")>-1?"&":"?"),n=e.fields;return angular.forEach(n,function(e,n){t+="fields["+n+"_revision_id]=1&",angular.forEach(e,function(e){t+="fields["+n+"_"+e.name+"]=1&"})}),t+="fields[sort_name]=1&fields[first_name]=1&fields[last_name]=1&fields[external_identifier]=1&fields[email]=1&fields[street_address]=1&fields[city]=1&fields[name]=1&fields[contract_contact_id]=1&fields[contract_contract_id]=1&fields[jobcontract_revision_id]=1&fields[change_reason]=1&fields[created_date]=1&fields[effective_date]=1&fields[modified_date]=1&order_bys[1][column]=id&order_bys[1][order]=ASC&order_bys[2][column]=civicrm_hrjobcontract_revision_revision_id&order_bys[2][order]=ASC&order_bys[3][column]=-&order_bys[3][order]=ASC&order_bys[4][column]=-&order_bys[4][order]=ASC&order_bys[5][column]=-&order_bys[5][order]=ASC&contract_id_op=eq&permission=access+CiviReport&row_count=&_qf_Summary_submit_csv=Preview+CSV&groups=&contract_id_value="+_+"&group_bys[civicrm_hrjobcontract_revision_revision_id]=1"}d.debug("Controller: RevisionListCtrl");var _=e.contract.id,b=e.revisionDataList;e.currentPage=1,e.itemsPerPage=5,e.maxSize=5,e.sortCol="revisionEntityIdObj.effective_date",e.sortReverse=!0,e.display={effectiveDate:!0,position:!0,payScale:!0,totalSalary:!0,hours:!0,placeOfWork:!0,recordedBy:!0},p(),e.createPage=function(){var t=(e.currentPage-1)*e.itemsPerPage,n=t+e.itemsPerPage;e.revisionDataListPage=b.slice(t,n)},e.sortBy=function(n,r){"undefined"!=typeof n&&(e.sortCol==n?e.sortReverse=!e.sortReverse:e.sortCol=n),"undefined"!=typeof r&&(e.sortReverse=r),b=t("orderBy")(e.revisionDataList,e.sortCol,e.sortReverse)},e.urlCSV=m(),e.deleteRevision=function(t,n){if(1==e.revisionList.length)return void n.stopPropagation();if(t&&"number"==typeof+t){var c=r.open({appendTo:o.find("div").eq(0),templateUrl:i.pathApp+"views/modalDialog.html",size:"sm",controller:"ModalDialogCtrl",resolve:{content:function(){return{msg:"Are you sure you want to delete this job contract revision?"}}}});c.result.then(function(n){n&&(e.$broadcast("hrjc-loader-show"),a.deleteRevision(t).then(function(n){var r=0,o=e.revisionList.length;if(!n.is_error){for(r;r<o;r++)if(e.revisionList[r].id==t){e.revisionList.splice(r,1),e.revisionDataList.splice(r,1);break}if(e.sortBy(),e.createPage(),e.revisionCurrent.id!=h())return void e.$emit("updateContractView");e.$broadcast("hrjc-loader-hide")}}))})}},e.modalRevisionEdit=function(t){var n=t.effective_date,c=t.change_reason,s=r.open({appendTo:o.find("div").eq(0),templateUrl:i.pathApp+"views/modalChangeReason.html?v="+(new Date).getTime(),controller:"ModalChangeReasonCtrl",resolve:{content:function(){return{copy:{title:"Edit revision data"}}},date:function(){return n},reasonId:function(){return c}}});s.result.then(function(r){r.date==n&&r.reasonId==c||a.saveRevision({id:t.id,change_reason:r.reasonId,effective_date:r.date}).then(function(){t.effective_date=r.date,t.change_reason=r.reasonId,e.sortBy(),e.createPage(),e.revisionCurrent.id!=h()&&e.$emit("updateContractView")})})},e.$watch("currentPage",function(){e.createPage()}),e.$watch("revisionDataList.length",function(t,n){b=e.revisionDataList,t>n&&h(),e.sortBy(),e.createPage()})}])}),define("job-contract/controllers/modal/modal-change-reason",["common/moment","job-contract/controllers/controllers","job-contract/services/contract"],function(e,t){"use strict";t.controller("ModalChangeReasonCtrl",["$scope","$log","$uibModalInstance","content","date","reasonId","settings","ContractRevisionService",function(t,n,r,o,i,a,c,s){n.debug("Controller: ModalChangeReasonCtrl");var o=o||{},l=o.copy||{};l.title=l.title||"Revision data",t.change_reason=a||"",t.copy=l,t.effective_date=i||"",t.isPast=!1,t.dpOpen=function(e,n){e.preventDefault(),e.stopPropagation(),t[n]=!0},t.save=function(){s.validateEffectiveDate({contact_id:c.contactId,effective_date:t.effective_date}).then(function(n){n.success?r.close({reasonId:t.change_reason,date:t.effective_date?e(t.effective_date).format("YYYY-MM-DD"):""}):(CRM.alert(n.message,"Error","error"),t.$broadcast("hrjc-loader-hide"))})},t.cancel=function(){r.dismiss("cancel")},t.$watch("effective_date",function(e){t.isPast=new Date(e).setHours(0,0,0,0)<(new Date).setHours(0,0,0,0)})}])}),define("job-contract/services/contract-revision",["common/lodash","job-contract/services/services","job-contract/services/utils"],function(e,t){"use strict";t.factory("ContractRevisionService",["$filter","$resource","settings","$q","UtilsService","$log",function(t,n,r,o,i,a){function c(e){var n=t("formatDate")(e,"YYYY-MM-DD");return"Unspecified"!==n?n:e}return a.debug("Service: ContractRevisionService"),e.assign(n(r.pathRest,{action:"get",entity:"HRJobContractRevision",json:{}}),{validateEffectiveDate:function(e){return e.effective_date=c(e.effective_date),e.sequential=0,e.debug=r.debug,this.save({action:"validateeffectivedate",json:e},null).$promise.then(function(e){return e.values})}})}])}),define("job-contract/services/contract-files",["job-contract/services/services","job-contract/services/utils"],function(e){"use strict";e.factory("ContractFilesService",["$resource","settings","$q","UtilsService","FileUploader","$log",function(e,t,n,r,o,i){i.debug("Service: ContractFilesService");var a=e(t.pathFile+":action");return o.prototype.queueDelete=[],{delete:function(e,t,o){if(!e||"number"!=typeof+e||!t||"number"!=typeof+t||!o||"string"!=typeof o)return null;var i=n.defer();return a.save({action:"delete",entityTable:o,entityID:t,fileID:e},null,function(e){e.values&&!+e.values[0].result&&(e.is_error=1),r.errorHandler(e,"Unable to delete file",i)||i.resolve(e.values[0])},function(){i.reject("Unable to delete file")}),i.promise},get:function(e,t){if(!e||"number"!=typeof+e||!t||"string"!=typeof t)return null;var o=n.defer();return a.get({action:"list",entityTable:t,entityID:e},function(e){r.errorHandler(e,"Unable to fetch files",o)||o.resolve(e.values)},function(){o.reject("Unable to fetch files")}),o.promise},uploader:function(e,n){if(!e||"string"!=typeof e)return null;var r={url:t.pathFile+"upload",formData:[{entityTable:e}]};return n&&"number"==typeof n&&(r.queueLimit=n),new o(r)},upload:function(e,t){if(!e||"object"!=typeof e||!t||"number"!=typeof+t)return null;var r=n.defer(),o=[];return e.onBeforeUploadItem=function(e){e.formData.push({entityID:t})},e.onCompleteItem=function(e,t){o.push(t)},e.onErrorItem=function(e,t,n,o){r.reject("Could not upload file: "+e.file.name),i.error(" ===== Item Error: "+n+" ======"),i.error(" =====  - item ======"),i.error(e),i.error(" =====  - response ======"),i.error(t),i.error(" =====  - headers ======"),i.error(o)},e.onCompleteAll=function(){r.resolve(o)},e.uploadAll(),r.promise}}}])}),define("job-contract/controllers/modal/modal-contract",["common/angular","job-contract/controllers/controllers","job-contract/services/contract","job-contract/services/contract-revision","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-pay","job-contract/services/contract-leave","job-contract/services/contract-health","job-contract/services/contract-pension","job-contract/services/contract-files","job-contract/services/utils","common/services/pub-sub"],function(e,t){"use strict";t.controller("ModalContractCtrl",["$scope","$uibModal","$uibModalInstance","$q","$rootElement","$rootScope","$filter","ContractService","ContractRevisionService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","ContractFilesService","action","entity","content","files","UtilsService","utils","settings","$log","pubSub",function(t,n,r,o,i,a,c,s,l,u,d,f,v,p,h,m,_,b,y,g,j,C,$,w,S){function R(e){var t=c("formatDate")(e,Date);return"Unspecified"!==t?t:e}function D(){var e=n.open({appendTo:i.find("div").eq(0),templateUrl:$.pathApp+"views/modalChangeReason.html?v="+(new Date).getTime(),controller:"ModalChangeReasonCtrl",resolve:{content:function(){return{copy:{title:U.title}}},date:null,reasonId:null}});return e.result}function P(){var e=n.open({appendTo:i.find("div").eq(0),templateUrl:$.pathApp+"views/modalConfirmEdit.html?v="+(new Date).getTime(),controller:"ModalDialogCtrl",resolve:{content:function(){return{msg:"Save without making a new revision?"}}}});return e.result}function M(){t.$broadcast("hrjc-loader-show");var a,c,l,_,b,y=e.copy(t.entity),g=t.filesTrash,j=t.uploader,C={contract:s.save(y.contract),details:u.save(y.details),hour:d.save(y.hour),pay:f.save(y.pay),leave:v.save(y.leave),health:p.save(y.health),pension:h.save(y.pension)},w=[],R=[];for(a in g)for(l=0,_=g[a].length,l;l<_;l++)c=g[a][l],R.push(m.delete(c.fileID,c.entityID,c.entityTable));e.extend(C,{files:!!R.length&&o.all(R)}),o.all(C).then(function(r){return e.forEach(j,function(n){e.forEach(n,function(n){e.forEach(n.queue,function(e){e.file.size>t.fileMaxSize&&e.remove()})})}),j.details.contract_file.queue.length&&w.push(m.upload(j.details.contract_file,y.details.jobcontract_revision_id)),j.pension.evidence_file.queue.length&&w.push(m.upload(j.pension.evidence_file,y.pension.jobcontract_revision_id)),r.details.period_start_date=y.details.period_start_date,r.details.period_end_date=y.details.period_end_date,r.pay.annual_benefits=y.pay.annual_benefits,r.pay.annual_deductions=y.pay.annual_deductions,w.length?(b=n.open({appendTo:i.find("div").eq(0),templateUrl:$.pathApp+"views/modalProgress.html?v="+(new Date).getTime(),size:"sm",controller:"ModalProgressCtrl",resolve:{uploader:function(){return j},promiseFilesUpload:function(){return w}}}),r.files=b.result,o.all(r)):r}).then(function(e){t.$broadcast("hrjc-loader-hide"),r.close(e),S.publish("contract-refresh")},function(e){t.$broadcast("hrjc-loader-hide"),CRM.alert(e,"Error","error"),r.dismiss()})}function L(e,n){t.$broadcast("hrjc-loader-show"),l.validateEffectiveDate({contact_id:$.contactId,effective_date:n}).then(function(r){r.success?F(e,n):(CRM.alert(r.message,"Error","error"),t.$broadcast("hrjc-loader-hide"))},function(e){})}function F(a,c){var l,_,y,g,C,w,R,D,P,M,L=e.copy(t.entity),F=t.filesTrash,U=t.uploader,E=[],H=0,q=0,A=0,I={},x=[],T=[],O={details:u,hour:d,pay:f,leave:v,health:p,pension:h};for(l in O){if(R=!e.equals(b[l],L[l]),!R&&(R=!!F[l]&&!!F[l].length,!R&&U[l]))for(y in U[l])if(_=U[l][y],_.queue.length){R=!0;break}R&&(E[A]={},E[A].name=l,E[A].data=L[l],E[A].service=O[l],A++,H=A)}H?(j.prepareEntityIds(E[0].data,b.contract.id),E[0].service.save(E[0].data).then(function(t){for(M=e.isArray(t)?t[0].jobcontract_revision_id:t.jobcontract_revision_id,A=1,I[E[0].name]=t,A;A<H;A++)l=E[A].name,j.prepareEntityIds(E[A].data,b.contract.id,M),I[l]=E[A].service.save(E[A].data);return o.all(e.extend(I,{revisionCreated:s.saveRevision({id:M,change_reason:a,effective_date:c})},{files:!1}))}).then(function(t){for(l in O)if(t[l]=t[l]||L[l],F[l]&&F[l].length)for(A=0,C=F[l].length,A;A<C;A++)g=F[l][A],x.push(m.delete(g.fileID,M,g.entityTable));return t.details.period_start_date=L.details.period_start_date,t.details.period_end_date=L.details.period_end_date,t.revisionCreated.effective_date=c||"",t.pay.annual_benefits=L.pay.annual_benefits,t.pay.annual_deductions=L.pay.annual_deductions,e.extend(t.revisionCreated,{details_revision_id:t.details.jobcontract_revision_id,health_revision_id:t.health.jobcontract_revision_id,hour_revision_id:t.hour.jobcontract_revision_id,jobcontract_id:b.contract.id,leave_revision_id:t.leave[0].jobcontract_revision_id,pay_revision_id:t.pay.jobcontract_revision_id,pension_revision_id:t.pension.jobcontract_revision_id}),x.length?(t.files=o.all(x),o.all(t)):t}).then(function(e){for(A=0;A<H;A++)if(l=E[A].name,U[l])for(y in U[l]){for(_=U[l][y],q=_.queue.length,w=0;w<q;w++)D=_.queue[w],D.file.size>t.fileMaxSize&&(D.remove(),w--,q--);q&&T.push(m.upload(_,M))}return T.length?(P=n.open({appendTo:i.find("div").eq(0),templateUrl:$.pathApp+"views/modalProgress.html",size:"sm",controller:"ModalProgressCtrl",resolve:{uploader:function(){return U},promiseFilesUpload:function(){return T}}}),e.files=P.result,o.all(e)):e}).then(function(e){t.$broadcast("hrjc-loader-hide"),r.close(e),S.publish("contract-refresh")})):(t.$broadcast("hrjc-loader-hide"),r.close())}w.debug("Controller: ModalContractCtrl");var y=y||{},U=y.copy||{},_=_||"view";U.close=U.close||"Close",U.save=U.save||"Save changes",U.title=U.title||"Contract",t.allowSave="undefined"!=typeof y.allowSave&&y.allowSave,t.entity={},t.action=_,t.copy=U,t.fileMaxSize=$.CRM.maxFileSize||0,t.files={},t.filesTrash={},t.isDisabled="undefined"==typeof y.isDisabled||y.isDisabled,t.isPrimaryDisabled=+b.contract.is_primary,t.showIsPrimary=C.contractListLen>1&&"change"!=_,t.uploader={details:{contract_file:m.uploader("civicrm_hrjobcontract_details")},pension:{evidence_file:m.uploader("civicrm_hrjobcontract_pension",1)}},t.utils=C,e.copy(b,t.entity),e.copy(g,t.files),t.entity.details.period_start_date=R(t.entity.details.period_start_date),t.entity.details.period_end_date=R(t.entity.details.period_end_date),e.forEach(t.files,function(e,n){t.filesTrash[n]=[]}),r.opened.then(function(){a.$broadcast("hrjc-loader-hide")}),t.cancel=function(){if("view"==_||e.equals(b,t.entity)&&e.equals(g,t.files)&&!t.uploader.details.contract_file.queue.length&&!t.uploader.pension.evidence_file.queue.length)return t.$broadcast("hrjc-loader-hide"),void r.dismiss("cancel");$.debug&&e.forEach(b,function(n,r){e.equals(n,t.entity[r])||(w.debug("======================"),w.debug("Changed entity: "+r),w.debug("Before:"),w.debug(n),w.debug("After:"),w.debug(t.entity[r]))});var o=n.open({appendTo:i.find("div").eq(0),templateUrl:$.pathApp+"views/modalDialog.html?v="+(new Date).getTime(),size:"sm",controller:"ModalDialogCtrl",resolve:{content:function(){return{copyCancel:"No",title:"Alert",msg:"Are you sure you want to cancel? Changes will be lost!"}}}});o.result.then(function(e){e&&(t.$broadcast("hrjc-loader-hide"),r.dismiss("cancel"))})},t.fileMoveToTrash=function(e,n){var r=t.files[n],o=t.filesTrash[n];o.push(r[e]),r.splice(e,1)},t.filesValidate=function(){var e,n,r,o,i,a,c,s=t.fileMaxSize,l=t.uploader,u=!0;for(e in l){r=l[e];for(n in r)for(o=r[n],i=o.queue,a=0,c=i.length;a<c&&u;a++)u=i[a].file.size<s}t.contractForm.$setValidity("maxFileSize",u)},e.forEach(t.uploader,function(n){e.forEach(n,function(e){e.onAfterAddingAll=function(){t.filesValidate()}})}),t.allowSave&&(t.save=function(){t.$broadcast("hrjc-loader-show"),u.validateDates({contact_id:$.contactId,period_start_date:t.entity.details.period_start_date,period_end_date:t.entity.details.period_end_date,jobcontract_id:b.contract.id}).then(function(n){if(n.success){if(e.equals(b,t.entity)&&e.equals(g,t.files)&&!t.uploader.details.contract_file.queue.length&&!t.uploader.pension.evidence_file.queue.length)return t.$broadcast("hrjc-loader-hide"),void r.dismiss("cancel");switch(_){case"edit":t.entity.contract.is_primary==b.contract.is_primary?P().then(function(e){switch(e){case"edit":M();break;case"change":D().then(function(e){L(e.reasonId,e.date)})}}):M();break;case"change":D().then(function(e){L(e.reasonId,e.date)});break;default:return t.$broadcast("hrjc-loader-hide"),void r.dismiss("cancel")}}else CRM.alert(n.message,"Error","error"),t.$broadcast("hrjc-loader-hide")},function(e){}),t.$broadcast("hrjc-loader-hide")})}])}),define("job-contract/controllers/modal/modal-contract-new",["common/moment","common/angular","job-contract/controllers/controllers","job-contract/services/contract","job-contract/services/contract-details","job-contract/services/contract-hour","job-contract/services/contract-pay","job-contract/services/contract-leave","job-contract/services/contract-health","job-contract/services/contract-pension","job-contract/services/contract-files","job-contract/services/utils","common/services/pub-sub"],function(e,t,n){"use strict";n.controller("ModalContractNewCtrl",["$scope","$uibModalInstance","$q","$uibModal","$rootElement","$sce","Contract","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService","ContractFilesService","model","UtilsService","utils","settings","$log","pubSub",function(n,r,o,i,a,c,s,l,u,d,f,v,p,h,m,_,b,y,g,j,C){j.debug("Controller: ModalContractNewCtrl"),n.allowSave=!0,n.action="new",n.copy={close:"Cancel",save:"Add New Job Contract",title:"Add New Job Contract"},n.entity={},n.isDisabled=!1,n.showIsPrimary=y.contractListLen,n.fileMaxSize=g.CRM.maxFileSize||0,n.uploader={details:{contract_file:m.uploader("civicrm_hrjobcontract_details")},pension:{evidence_file:m.uploader("civicrm_hrjobcontract_pension",1)}},n.utils=y,t.copy(_,n.entity),n.entity.contract={is_primary:0},n.tooltips={fileSize:c.trustAsHtml("<p>THE FILE IS TOO LARGE AND CANNOT BE UPLOADED. PLEASE REDUCE THE SIZE OF THE FILE AND TRY AGAIN.</p>"),fte:c.trustAsHtml("<div><strong>FTE</strong> stands forFull Time Equivalent. This is a useful measure foran organisation that has peopleworking part-time.For a full-time person, FTE is always equal to1.0, whereas for a part-time person, the FTE will representthe fraction of standard hours that the person works on aregular basis.<br>E.g. if the standard working day at an organisationcomprises of 8 hours, then a person who regularly works for8 hours each day would be considered to be full- time andwould have an FTE value of 1.0. A person who regularly worksfor only 4 hours each day would be considered to be apart-time person and would have an FTE value of 0.5. If theorganisation had 10 people, each with an FTE of 1.0 theactual headcount of full-time people would be 10 and theFTE headcount (equal to actual headcount multiplied by theFTE value) would also be 10. However, if the organisationhad another 10 people who each worked part-time with an FTEvalue of 0.5 the actual headcount of part-time people wouldbe 10 while the FTE headcount would only be 5. Thus for anorganisation that had a total of 10 full-time people, and 10part-time people (each with an FTE of 0.5) the actualheadcount for the organisation would be 20 while the FTEheadcount would be 15.</div>")},n.filesValidate=function(){var e,t,r,o,i,a,c,s=n.fileMaxSize,l=n.uploader,u=!0;for(e in l){r=l[e];for(t in r)for(o=r[t],i=o.queue,a=0,c=i.length;a<c&&u;a++)u=i[a].file.size<s}n.contractForm.$setValidity("maxFileSize",u)},t.forEach(n.uploader,function(e){t.forEach(e,function(e){e.onAfterAddingAll=function(){n.filesValidate()}})}),n.cancel=function(){r.dismiss("cancel")},n.save=function(){n.$broadcast("hrjc-loader-show");var c=new s;u.validateDates({contact_id:g.contactId,period_start_date:n.entity.details.period_start_date,period_end_date:n.entity.details.period_end_date}).then(function(s){s.success?c.$save({action:"create",json:{sequential:1,contact_id:g.contactId,is_primary:y.contractListLen?n.entity.contract.is_primary:1}},function(c){var s,_,y,j=c.values[0],$=j.id,w=t.copy(n.entity.details),S=n.entity.hour,R=n.entity.pay,D=n.entity.leave,P=n.entity.health,M=n.entity.pension,L=[],F=n.uploader;j.is_current=!w.period_end_date||e().diff(w.period_end_date,"day")<=0,b.prepareEntityIds(w,$),u.save(w).then(function(e){y=e.jobcontract_revision_id},function(e){return CRM.alert(e,"Error","error"),l.delete($),r.dismiss(),o.reject()}).then(function(){return t.forEach(n.entity,function(e){b.prepareEntityIds(e,$,y)}),_=[d.save(S),f.save(R),v.save(D),p.save(P),h.save(M)],n.uploader.details.contract_file.queue.length&&L.push(m.upload(F.details.contract_file,y)),n.uploader.pension.evidence_file.queue.length&&L.push(m.upload(F.pension.evidence_file,y)),L.length&&(s=i.open({appendTo:a.find("div").eq(0),templateUrl:g.pathApp+"views/modalProgress.html",size:"sm",controller:"ModalProgressCtrl",resolve:{uploader:function(){return F},promiseFilesUpload:function(){return L}}}),_.push(s.result)),o.all(_)},function(e){return CRM.alert(e,"Error","error"),r.dismiss(),o.reject()}).then(function(){n.$broadcast("hrjc-loader-hide"),r.close(j),C.publish("contract:created",g.contactId),C.publish("contract-refresh")})},function(e){return n.$broadcast("hrjc-loader-hide"),r.dismiss(),CRM.alert(e.statusText||"Unknown error","Error","error"),o.reject()}):(CRM.alert(s.message,"Error","error"),n.$broadcast("hrjc-loader-hide"))},function(e){})}}])}),define("job-contract/controllers/modal/modal-dialog",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("ModalDialogCtrl",["$scope","$uibModalInstance","$timeout","content","$log",function(e,t,n,r,o){o.debug("Controller: ModalDialogCtrl"),e.title=r.title||"CiviHR Job Contract",e.msg=r.msg||"",e.copyConfirm=r.copyConfirm||"Yes",e.copyCancel=r.copyCancel||"Cancel",e.confirm=function(e){t.close(e||!0)},e.cancel=function(){t.dismiss("Cancel")}}])}),define("job-contract/controllers/modal/modal-progress",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("ModalProgressCtrl",["$scope","$uibModalInstance","$q","$timeout","uploader","promiseFilesUpload","$log",function(e,t,n,r,o,i,a){a.debug("Controller: ModalProgressCtrl");var c,s;e.uploader=o;for(c in o)for(s in o[c])o[c][s].queue.length&&(o[c][s].item=o[c][s].queue[0].file.name),o[c][s].onProgressItem=function(e){this.item=e.file.name};n.all(i).then(function(e){r(function(){t.close(e)},500)}),e.cancel=function(){t.dismiss("File upload canceled")}}])}),define("job-contract/controllers/modal/modal-revision",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("ModalRevisionCtrl",["$scope","$rootScope","$uibModalInstance","$filter","$q","settings","revisionDataList","revisionList","entity","fields","model","modalContract","utils","ContactService","$log",function(e,t,n,r,o,i,a,c,s,l,u,d,f,v,p){function h(){var t,n,r=i.pathReport+(i.pathReport.indexOf("?")>-1?"&":"?"),o=e.entity;return angular.forEach(e.fields,function(e){t="editor_name"!=e.name?e.name:"editor_uid",n=e.extends?"":o+"_",e.selected&&(r+="fields["+n+t+"]=1&")}),r+="fields[sort_name]=1&fields[first_name]=1&fields[last_name]=1&fields[external_identifier]=1&fields[email]=1&fields[street_address]=1&fields[city]=1&fields[name]=1&fields[contract_contact_id]=1&fields[contract_contract_id]=1&fields[jobcontract_revision_id]=1&fields[change_reason]=1&fields[created_date]=1&fields[effective_date]=1&fields[modified_date]=1&order_bys[1][column]=id&order_bys[1][order]=ASC&order_bys[2][column]=civicrm_hrjobcontract_revision_revision_id&order_bys[2][order]=ASC&order_bys[3][column]=-&order_bys[3][order]=ASC&order_bys[4][column]=-&order_bys[4][order]=ASC&order_bys[5][column]=-&order_bys[5][order]=ASC&contract_id_op=eq&permission=access+CiviReport&row_count=&_qf_Summary_submit_csv=Preview+CSV&groups=&contract_id_value="+c[0].jobcontract_id+"&group_bys[civicrm_hrjobcontract_revision_revision_id]=1"}switch(p.debug("Controller: ModalRevisionCtrl"),e.$broadcast("hrjc-loader-show"),e.currentPage=1,e.entity=s,e.fields=angular.copy(l),e.itemsPerPage=5,e.revisionDataList=[],e.revisionList=[],e.sortCol="effective_date",e.subFields={},e.maxSize=5,e.modalContract=d,e.sortReverse=!0,function(){var t,n=0,r=e.fields.length;for(n;n<r;n++)t=e.fields[n],t.selected=!0,t.isArray="leave_type"==t.name||"leave_amount"==t.name,"id"!=t.name&&"jobcontract_revision_id"!=t.name?t.display=!0:t.display=!1;e.fields.unshift({name:"effective_date",title:"Effective Date",display:!0,selected:!0,isArray:!1,extends:!0}),e.fields.push({name:"editor_name",title:"Change Recorded By",display:!0,selected:!0,isArray:!1,extends:!0},{name:"change_reason",title:"Reason For Change",display:!0,selected:!0,isArray:!1,extends:!0})}(),function(){var n,o,i=0,s=a.length;for(i;i<s;i++)n=i+1,o=n==s,a[i]||(a[i]=u),o||a[n]||(a[n]=u),angular.isArray(a[i])&&(a[i]={jobcontract_revision_id:a[i][0].jobcontract_revision_id,data:a[i]}),angular.extend(a[i],{effective_date:r("date")(c[i].effective_date,"yyyy/MM/dd")||"",editor_name:c[i].editor_name||"",change_reason:t.options.contract.change_reason[c[i].change_reason]||"",details_revision_id:c[i].details_revision_id,health_revision_id:c[i].health_revision_id,hour_revision_id:c[i].hour_revision_id,leave_revision_id:c[i].leave_revision_id,pay_revision_id:c[i].pay_revision_id,pension_revision_id:c[i].pension_revision_id,role_revision_id:c[i].role_revision_id}),e.revisionDataList.push(a[i])}(),s){case"hour":!function(){var t;angular.forEach(e.revisionDataList,function(e){e.location_standard_hours&&(t=r("filter")(f.hoursLocation,{id:e.location_standard_hours})[0],e.location_standard_hours=t.location+": "+t.standard_hours+"h per "+t.periodicity)})}();break;case"health":angular.forEach(e.revisionDataList,function(e){e.provider&&v.getOne(e.provider).then(function(t){e.provider=t.label}),e.provider_life_insurance&&v.getOne(e.provider_life_insurance).then(function(t){e.provider_life_insurance=t.label})});break;case"pay":!function(){var n;angular.forEach(e.revisionDataList,function(e){e.pay_scale&&(n=r("filter")(f.payScaleGrade,{id:e.pay_scale})[0]||r("filter")(f.payScaleGrade,{pay_scale:e.pay_scale})[0],e.pay_scale=n.pay_scale+(n.pay_grade?" - "+n.pay_grade:"")+(n.currency?" - "+t.options.pay.pay_currency[n.currency]:"")+(n.amount?" "+n.amount:"")+(n.periodicity?" per "+n.periodicity:""))})}(),r("filter")(e.fields,{name:"pay_is_auto_est"})[0].pseudoconstant=!0,e.subFields={annual_benefits:[{name:"name",title:"Benefit",pseudoconstant:"benefit_name"},{name:"type",title:"Type",pseudoconstant:"benefit_type"},{name:"amount_pct",title:"% amount",pseudoconstant:!1},{name:"amount_abs",title:"Absolute amount",pseudoconstant:!1}],annual_deductions:[{name:"name",title:"Deduction",pseudoconstant:"deduction_name"},{name:"type",title:"Type",pseudoconstant:"deduction_type"},{name:"amount_pct",title:"% amount",pseudoconstant:!1},{name:"amount_abs",title:"Absolute amount",pseudoconstant:!1}]};break;case"pension":r("filter")(e.fields,{name:"is_enrolled"})[0].pseudoconstant=!0}e.urlCSV=h(),e.createPage=function(){var t=(e.currentPage-1)*e.itemsPerPage,n=t+e.itemsPerPage;e.revisionDataListPage=e.revisionDataList.slice(t,n)},e.sortBy=function(t,n){"undefined"!=typeof t&&(e.sortCol==t?e.sortReverse=!e.sortReverse:e.sortCol=t),"undefined"!=typeof n&&(e.sortReverse=n),e.revisionDataList=r("orderBy")(e.revisionDataList,e.sortCol,e.sortReverse)},e.sortBy(),e.toggleFieldsSelected=function(t){t.selected=!t.selected,e.urlCSV=h()},n.opened.then(function(){t.$broadcast("hrjc-loader-hide")}),e.cancel=function(){n.dismiss("cancel")},e.$watch("currentPage",function(){e.createPage()})}])}),define("job-contract/controllers/form/form-general",["common/moment","job-contract/controllers/controllers","common/filters/angular-date/format-date"],function(e,t){"use strict";t.controller("FormGeneralCtrl",["$scope","$log","HR_settings",function(t,n,r){function o(t,n){if(!t||!n)return null;var r,o,i,a;return i=e(n),i.add(1,"days"),a=i.diff(t,"years"),i.add(-a,"years"),o=i.diff(t,"months"),i.add(-o,"months"),r=i.diff(t,"days"),a=a>0?a>1?a+" years ":a+" year ":"",o=o>0?o>1?o+" months ":o+" month ":"",r=r>0?r>1?r+" days":r+" day":"",a+o+r||"0 days"}function i(t,n){return n=n||"min",e(t)["max"===n?"subtract":"add"](1,"day").toDate()}function a(){return{start:{maxDate:c.period_end_date?i(c.period_end_date,"max"):null},end:{minDate:c.period_start_date?i(c.period_start_date,"min"):null}}}n.debug("Controller: FormGeneralCtrl");var c=t.entity.details;t.format=r.DATE_FORMAT,t.datepickerOptions=a(),t.dpOpen=function(e,n){e.preventDefault(),e.stopPropagation(),t[n]=!0},t.$watch("entity.details.period_start_date",function(){t.datepickerOptions.end.minDate=i(c.period_start_date,"min"),t.duration=o(c.period_start_date,c.period_end_date)}),t.$watch("entity.details.period_end_date",function(){c.period_end_date?t.datepickerOptions.start.maxDate=i(c.period_end_date,"max"):(t.datepickerOptions.start.maxDate=null,c.end_reason=null),t.duration=o(c.period_start_date,c.period_end_date)}),t.$watch("entity.details.position",function(e,n){e!==n&&c.title===n&&(t.contractForm.detailsTitle.$setViewValue(e),t.contractForm.detailsTitle.$render())}),t.$watch("entity.details.notice_amount",function(e,n){+e&&!c.notice_unit&&(t.contractForm.detailsNoticeUnit.$setValidity("required",!1),t.contractForm.detailsNoticeUnit.$dirty=!0),e!==n&&c.notice_amount_employee===n&&(c.notice_amount_employee=e)}),t.$watch("entity.details.notice_amount_employee",function(e){+e&&!c.notice_unit_employee&&(t.contractForm.detailsNoticeUnitEmployee.$setValidity("required",!1),t.contractForm.detailsNoticeUnitEmployee.$dirty=!0)}),t.$watch("entity.details.notice_unit",function(e,t){e!==t&&c.notice_unit_employee===t&&(c.notice_unit_employee=e)})}])}),define("job-contract/vendor/fraction",[],function(){var e=function(t,n){if("undefined"!=typeof t&&n)"number"==typeof t&&"number"==typeof n?(this.numerator=t,this.denominator=n):"string"==typeof t&&"string"==typeof n&&(this.numerator=parseInt(t),this.denominator=parseInt(n));else if("undefined"==typeof n)if(num=t,"number"==typeof num)this.numerator=num,this.denominator=1;else if("string"==typeof num){var r,o,i=num.split(" ");if(i[0]&&(r=i[0]),i[1]&&(o=i[1]),r%1===0&&o&&o.match("/"))return new e(r).add(new e(o));if(!r||o)return;if("string"==typeof r&&r.match("/")){var a=r.split("/");this.numerator=a[0],this.denominator=a[1]}else{if("string"==typeof r&&r.match("."))return new e(parseFloat(r));this.numerator=parseInt(r),this.denominator=1}}this.normalize()};return e.prototype.clone=function(){return new e(this.numerator,this.denominator)},e.prototype.toString=function(){if("NaN"===this.denominator)return"NaN";var e=this.numerator/this.denominator>0?Math.floor(this.numerator/this.denominator):Math.ceil(this.numerator/this.denominator),t=this.numerator%this.denominator,n=this.denominator,r=[];return 0!=e&&r.push(e),0!=t&&r.push((0===e?t:Math.abs(t))+"/"+n),r.length>0?r.join(" "):0},e.prototype.rescale=function(e){return this.numerator*=e,this.denominator*=e,this},e.prototype.add=function(t){var n=this.clone();return t=t instanceof e?t.clone():new e(t),td=n.denominator,n.rescale(t.denominator),t.rescale(td),n.numerator+=t.numerator,n.normalize()},e.prototype.subtract=function(t){var n=this.clone();return t=t instanceof e?t.clone():new e(t),td=n.denominator,n.rescale(t.denominator),t.rescale(td),n.numerator-=t.numerator,n.normalize()},e.prototype.multiply=function(t){var n=this.clone();if(t instanceof e)n.numerator*=t.numerator,n.denominator*=t.denominator;else{if("number"!=typeof t)return n.multiply(new e(t));n.numerator*=t}return n.normalize()},e.prototype.divide=function(t){var n=this.clone();if(t instanceof e)n.numerator*=t.denominator,n.denominator*=t.numerator;else{if("number"!=typeof t)return n.divide(new e(t));n.denominator*=t}return n.normalize()},e.prototype.equals=function(t){t instanceof e||(t=new e(t));var n=this.clone().normalize(),t=t.clone().normalize();return n.numerator===t.numerator&&n.denominator===t.denominator},e.prototype.normalize=function(){var t=function(e){return"number"==typeof e&&(e>0&&e%1>0&&e%1<1||e<0&&e%-1<0&&e%-1>-1)},n=function(e,t){if(t){var n=Math.pow(10,t);return Math.round(e*n)/n}return Math.round(e)};return function(){if(t(this.denominator)){var r=n(this.denominator,9),o=Math.pow(10,r.toString().split(".")[1].length);this.denominator=Math.round(this.denominator*o),this.numerator*=o}if(t(this.numerator)){var r=n(this.numerator,9),o=Math.pow(10,r.toString().split(".")[1].length);this.numerator=Math.round(this.numerator*o),this.denominator*=o}var i=e.gcf(this.numerator,this.denominator);return this.numerator/=i,this.denominator/=i,(this.numerator<0&&this.denominator<0||this.numerator>0&&this.denominator<0)&&(this.numerator*=-1,this.denominator*=-1),this}}(),e.gcf=function(t,n){var r=[],o=e.primeFactors(t),i=e.primeFactors(n);if(o.forEach(function(e){var t=i.indexOf(e);t>=0&&(r.push(e),i.splice(t,1))}),0===r.length)return 1;var a=function(){var e,t=r[0];for(e=1;e<r.length;e++)t*=r[e];
return t}();return a},e.primeFactors=function(e){for(var t=Math.abs(e),n=[],r=2;r*r<=t;)t%r===0?(n.push(r),t/=r):r++;return 1!=t&&n.push(t),n},e}),define("job-contract/controllers/form/form-hour",["job-contract/vendor/fraction","job-contract/controllers/controllers"],function(e,t){"use strict";t.controller("FormHourCtrl",["$scope","$rootScope","$filter","$log",function(t,n,r,o){function i(e,n){if(t.hrsTypeDefined=!!c.hours_type,t.hrsAmountDefined=!!c.hours_amount,t.hrsTypeDefined&&!t.hrsAmountDefined)switch(c.hours_unit=e.periodicity,+n){case 8:c.hours_amount=e.standard_hours;break;case 4:c.hours_amount=Math.round(e.standard_hours/2);break;case 0:c.hours_amount=0;break;default:c.hours_amount=""}else t.hrsAmountDefined||t.hrsAmountDefined||(c.hours_amount="",c.hours_unit="")}function a(n,r){r=parseFloat(r)||0,n=parseFloat(n)||0;var o=new e(r,n);c.fte_num=String(+c.hours_type?o.numerator:0),c.fte_denom=String(+c.hours_type?o.denominator:0),c.hours_fte=String(parseFloat((c.fte_num/c.fte_denom||0).toFixed(2))),t.fteFraction=c.fte_num+"/"+c.fte_denom}o.debug("Controller: FormHourCtrl");var c=t.entity.hour,s=t.utils.hoursLocation,l={};t.hrsTypeDefined=!1,t.hrsAmountDefined=!1,c.location_standard_hours=c.location_standard_hours||"1",l=r("getObjById")(s,c.location_standard_hours),t.$watch("entity.hour.location_standard_hours",function(e){l=r("getObjById")(s,e),i(l,c.hours_type),a(l.standard_hours,c.hours_amount)}),t.$watch("entity.hour.hours_type",function(e,t){e!=t&&(i(l,e),a(l.standard_hours,c.hours_amount))}),t.$watch("entity.hour.hours_amount",function(e,t){e!=t&&a(l.standard_hours,e)}),t.$watch("entity.hour.hours_unit",function(e,t){e!=t&&a(l.standard_hours,c.hours_amount)})}])}),define("job-contract/controllers/form/form-health",["job-contract/controllers/controllers","job-contract/services/contact"],function(e){"use strict";e.controller("FormHealthCtrl",["$scope","ContactService","$log",function(e,t,n){n.debug("Controller: FormHealthCtrl"),e.contacts={Health_Insurance_Provider:[],Life_Insurance_Provider:[]},e.refreshContacts=function(n,r){n&&t.search(n,{contact_type:"Organization",contact_sub_type:r}).then(function(t){e.contacts[r]=t})},e.entity.health.provider&&t.getOne(e.entity.health.provider).then(function(t){e.contacts.Health_Insurance_Provider.push(t)}),e.entity.health.provider_life_insurance&&t.getOne(e.entity.health.provider_life_insurance).then(function(t){e.contacts.Life_Insurance_Provider.push(t)})}])}),define("job-contract/controllers/form/form-pay",["job-contract/controllers/controllers"],function(e){"use strict";e.controller("FormPayCtrl",["$scope","$filter","settings","$log",function(e,t,n,r){function o(){var e=1;switch(+i.pay_cycle){case 1:e=s.Week;break;case 2:e=s.Month}return e}r.debug("Controller: FormPayCtrl");var i=e.entity.pay||{},a={pay_amount:0,pay_currency:n.CRM.defaultCurrency,pay_cycle:"2",pay_unit:"Year"},c=e.utils.payScaleGrade,s={Year:1,Month:12,Week:52,Fortnight:26,Day:260,Hour:2080};i.is_paid=i.is_paid||0,i.pay_is_auto_est="0",i.annual_benefits=i.annual_benefits||[],i.annual_deductions=i.annual_deductions||[],e.collapseBenDed=!i.annual_benefits.length&&!i.annual_deductions.length,e.benefits_per_cycle=(0).toFixed(2),e.benefits_per_cycle_net=0,e.deductions_per_cycle=(0).toFixed(2),e.add=function(e){e.push({name:"",type:"",amount_pct:"",amount_abs:""})},e.applyPayScaleGradeData=function(){if(i.pay_scale){var e=t("getObjById")(c,i.pay_scale);i.pay_amount=e.amount||a.pay_amount,i.pay_currency=e.currency||a.pay_currency,i.pay_unit=e.periodicity||a.pay_unit}},e.calcAnnualPayEst=function(){var t=e.entity.hour;if(+i.is_paid){var n=s.Week*t.hours_amount,r=i.pay_amount*s[i.pay_unit]/s.Hour;i.pay_annualized_est=n*r}},e.calcBenefitsPerCycle=function(){if(+i.is_paid){var t=0,n=i.annual_benefits.length,r=0;for(t;t<n;t++)2==+i.annual_benefits[t].type&&(i.annual_benefits[t].amount_abs=(i.annual_benefits[t].amount_pct/100*i.pay_annualized_est).toFixed(2)),r+=+i.annual_benefits[t].amount_abs;e.benefits_per_cycle=(r/o()).toFixed(2)}},e.calcBenefitsPerCycleNet=function(){+i.is_paid&&(e.benefits_per_cycle_net=e.benefits_per_cycle-e.deductions_per_cycle)},e.calcDeductionsPerCycle=function(){if(+i.is_paid){var t=0,n=i.annual_deductions.length,r=0;for(t;t<n;t++)2==+i.annual_deductions[t].type&&(i.annual_deductions[t].amount_abs=(i.annual_deductions[t].amount_pct/100*i.pay_annualized_est).toFixed(2)),r+=+i.annual_deductions[t].amount_abs;e.deductions_per_cycle=(r/o()).toFixed(2)}},e.calcPayPerCycleGross=function(){+i.is_paid&&(i.pay_per_cycle_gross=(i.pay_annualized_est/o()).toFixed(2))},e.calcPayPerCycleNet=function(){+i.is_paid&&(i.pay_per_cycle_net=(+i.pay_per_cycle_gross+ +e.benefits_per_cycle_net).toFixed(2))},e.resetData=function(){i.pay_scale="",i.pay_amount="",i.pay_unit="",i.pay_currency="",i.pay_annualized_est="",i.pay_is_auto_est="",i.annual_benefits=[],i.annual_deductions=[],i.pay_cycle="",i.pay_per_cycle_gross="",i.pay_per_cycle_net="",e.benefits_per_cycle="",e.deductions_per_cycle=""},e.setDefaults=function(){i.pay_cycle=a.pay_cycle,i.pay_currency=a.pay_currency,i.pay_is_auto_est="0",i.pay_amount=(0).toFixed(2)},e.remove=function(e,t){e.splice(t,1)},e.$watch("entity.pay.pay_amount",e.calcAnnualPayEst),e.$watch("entity.pay.pay_unit",e.calcAnnualPayEst),e.$watch("entity.hour.hours_fte",e.calcAnnualPayEst),e.$watch("entity.pay.pay_annualized_est",function(){e.calcPayPerCycleGross(),e.calcBenefitsPerCycle(),e.calcDeductionsPerCycle()}),e.$watch("entity.pay.annual_benefits",e.calcBenefitsPerCycle,!0),e.$watch("entity.pay.annual_deductions",e.calcDeductionsPerCycle,!0),e.$watch("benefits_per_cycle",e.calcBenefitsPerCycleNet),e.$watch("deductions_per_cycle",e.calcBenefitsPerCycleNet),e.$watch("benefits_per_cycle_net",e.calcPayPerCycleNet),e.$watch("entity.pay.pay_per_cycle_gross",e.calcPayPerCycleNet)}])}),define("job-contract/controllers/form/form-pension",["job-contract/controllers/controllers","job-contract/services/contact"],function(e){"use strict";e.controller("FormPensionCtrl",["$scope","settings","$log",function(e,t,n){n.debug("Controller: FormPensionCtrl")}])}),define("job-contract/directives/directives",["common/angular"],function(e){"use strict";return e.module("hrjc.directives",[])}),define("job-contract/directives/contact",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcContact",["$compile","ContactService","settings","$log",function(e,t,n,r){return r.debug("Directive: hrjcContact"),{restrict:"A",scope:{renderAsLink:"=?hrjcContactLink",contactId:"=?hrjcContact"},template:"{{contact.label}}",link:function(n,r){n.contactId&&n.$watch("contactId",function(o){t.getOne(n.contactId).then(function(t){n.contact=t,n.renderAsLink&&(r.html('<a ng-href="/civicrm/contact/view?reset=1&cid={{contactId}}">{{contact.label}}</a>'),e(r.contents())(n))})})}}}])}),define("job-contract/directives/loader",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcLoader",["$rootScope","$log",function(e,t){return t.debug("Directive: hrjcLoader"),{link:function(e,t,n){function r(){var e=window.getComputedStyle(t[0]).position;return"relative"==e||"absolute"==e||"fixed"==e}function o(){r()||(t.css("position","relative"),s=!0),t.append(a),c=!0}function i(){c&&a.parentNode.removeChild(a),c=!1,s&&t.css("position","")}var a=document.createElement("div"),c=!1,s=!1;a.className="hrjc-loader",n.hrjcLoaderShow&&o(),e.$on("hrjc-loader-show",function(){o()}),e.$on("hrjc-loader-hide",function(){i()})}}}])}),define("job-contract/directives/number",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcNumber",["$log",function(e){return e.debug("Directive: hrjcNumber"),{require:"ngModel",link:function(e,t,n,r){var o=2,i=n.hrjcNumberFloat||!1;n.hrjcNumber&&"number"==typeof+n.hrjcNumber&&(o=n.hrjcNumber),t.bind("blur",function(){var e=parseFloat(r.$viewValue)||0;r.$setViewValue(i?Math.round(100*e)/100:e.toFixed(o)),r.$render()})}}}])}),define("job-contract/directives/validate",["job-contract/directives/directives"],function(e){"use strict";e.directive("hrjcValidate",["$log",function(e){return e.debug("Directive: hrjcValidate"),{restrict:"A",require:"^form",scope:{isWarning:"=?hrjcValidateWarning"},link:function(e,t,n,r){function o(e,n){t.toggleClass("has-success",!e&&!n),d.toggleClass("glyphicon-ok",!e&&!n)}function i(e,n){t.toggleClass("has-warning",!e&&n),d.toggleClass("glyphicon-warning-sign",!e&&n)}function a(e){t.toggleClass("has-error",e),d.toggleClass("glyphicon-remove",e)}var c=t[0].querySelector("[name]"),s=angular.element(c),l=s.attr("name"),u=document.createElement("span"),d=angular.element(u);l&&(t.addClass("has-feedback"),d.addClass("glyphicon form-control-feedback"),s.after(d),e.$watch(function(){return r[l]&&r[l].$invalid},function(t){r[l].$dirty&&(o(t,e.isWarning),a(t))}),"undefined"!=typeof e.isWarning&&e.$watch("isWarning",function(e){var t=r[l].$invalid;r[l].$dirty&&(o(t,e),i(t,e))}),s.bind("blur",function(){a(r[l].$invalid)}))}}}])}),define("job-contract/filters/capitalize",["job-contract/filters/filters"],function(e){"use strict";e.filter("capitalize",["$log",function(e){return e.debug("Filter: capitalize"),function(e){return e?e.replace(/([^\W_]+[^\s-]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}):""}}])}),define("job-contract/filters/format-amount",["job-contract/filters/filters"],function(e){"use strict";e.filter("formatAmount",["$log",function(e){return e.debug("Filter: formatAmount"),function(e){return e&&e.indexOf(".")===-1?e+".00":e}}])}),define("job-contract/filters/format-period",["job-contract/filters/filters"],function(e){"use strict";e.filter("formatPeriod",["$filter","$log",function(e,t){return t.debug("Filter: formatPeriod"),function(t){return t?e("date")(t,"yyyy/MM/dd"):"Unspecified"}}])}),define("job-contract/filters/parse-int",["job-contract/filters/filters"],function(e){"use strict";e.filter("parseInt",["$log",function(e){return e.debug("Filter: parseInt"),function(e){return e?parseInt(e):null}}])}),define("job-contract/services/contract-revision-list",["common/lodash","job-contract/services/services"],function(e,t){"use strict";t.factory("ContractRevisionList",["$filter","$q","$log","ContractService","ContractFilesService","ContractRevisionService",function(t,n,r,o,i,a){function c(e){return{details:{position:e["details_revision_id.position"],location:e["details_revision_id.location"]},hour:{hours_type:e["hour_revision_id.hours_type"]},pay:{pay_annualized_est:e["pay_revision_id.pay_annualized_est"],pay_currency:e["pay_revision_id.pay_currency"],pay_scale:e["pay_revision_id.pay_scale"]}}}function s(t){return t.effective_date=t.effective_date||"",n.all({files:{details:i.get(t.details_revision_id,"civicrm_hrjobcontract_details")},aggregated:a.get({action:"getsingle",json:{sequential:1,id:t.id,return:["details_revision_id.position","details_revision_id.location","hour_revision_id.hours_type","pay_revision_id.pay_scale","pay_revision_id.pay_annualized_est","pay_revision_id.pay_currency"]}}).$promise.then(function(e){return e})}).then(function(n){return e.assign({revisionEntityIdObj:t,files:n.files},c(n.aggregated))})}function l(e){var r=[],i=[],a=n.defer();return o.getRevision(e).then(function(e){return r=t("orderBy")(e,["-effective_date","-id"]),n.all(r.map(s))}).then(function(e){i=e,a.resolve({revisionList:r,revisionDataList:e})}),a.promise}return r.debug("Service: ContractRevisionList"),{fetchRevisions:l}}])}),function(e,t){function n(){var e={nodiff:"",year:"year",years:"years",month:"month",months:"months",day:"day",days:"days",hour:"hour",hours:"hours",minute:"minute",minutes:"minutes",second:"second",seconds:"seconds",delimiter:" "};moment.fn.preciseDiff=function(e){return moment.preciseDiff(this,e)},moment.preciseDiff=function(t,n){function r(t,n){return t+" "+e[n+(1===t?"":"s")]}var o=moment(t),i=moment(n);if(o.isSame(i))return e.nodiff;if(o.isAfter(i)){var a=o;o=i,i=a}var c=i.year()-o.year(),s=i.month()-o.month(),l=i.date()-o.date();if(l<0){var u=moment(i.year()+"-"+(i.month()+1),"YYYY-MM").subtract("months",1).daysInMonth();l=u<o.date()?u+l+(o.date()-u):u+l,s--}s<0&&(s=12+s,c--);var d=[];return c&&d.push(r(c,"year")),s&&(c&&d.push(","),d.push(r(s,"month"))),l&&(s&&d.push("and"),d.push(r(l,"day"))),d.join(e.delimiter)}}function r(t,r,o){moment.preciseDiff||n();var i=moment(t,"MMMM DD, YYYY"),a="";if(r)var c=moment(r,"MMMM DD, YYYY");var s=moment();if(r)var l=c.diff(s,"days");else var l=s.diff(i,"days");a=l<0?moment.preciseDiff(i,c):moment().preciseDiff(i);var u=s.diff(i,"days");u<=0&&(a="0 days"),e("#initial_join_date").remove();var d="<div class='crm-summary-row' id='initial_join_date'><div class='crm-label'>Length Of Employment</div><div class='crm-content crm-custom-data lengthEmployment'></div></div>";e("#custom-set-content-"+o+" .crm-inline-block-content").append(d),e(".lengthEmployment").html(a),r&&l<0&&e(".lengthEmployment").css({color:"#FF0000"})}var o=CRM.grID,i=e("#custom-set-content-"+o+" .crm-inline-block-content div:nth-child(2) .crm-custom-data").html(),a=e("#custom-set-content-"+o+" .crm-inline-block-content div:nth-child(3) .crm-custom-data").html();i&&r(i,a,o),e(document).on("click","#_qf_CustomData_upload",function(){e(document).ajaxSuccess(function(t,n,i){i.extraData&&"CRM_Contact_Form_Inline_CustomData"==i.extraData.class_name&&i.extraData.groupID==o&&setTimeout(function(){var t=e("#custom-set-content-"+o+" .crm-inline-block-content div:nth-child(2) .crm-custom-data").html(),n=e("#custom-set-content-"+o+" .crm-inline-block-content div:nth-child(3) .crm-custom-data").html();t&&r(t,n,o)},300)})})}(CRM.$,CRM._),define("job-contract/app",["common/angular","common/ui-select","common/services/dom-event-trigger","common/services/angular-date/date-format","common/modules/routers/compu-ng-route","common/modules/directives","common/directives/angular-date/date-input","job-contract/controllers/controllers","job-contract/controllers/contract-list","job-contract/controllers/contract","job-contract/controllers/revision-list","job-contract/controllers/modal/modal-change-reason","job-contract/controllers/modal/modal-contract","job-contract/controllers/modal/modal-contract-new","job-contract/controllers/modal/modal-dialog","job-contract/controllers/modal/modal-progress","job-contract/controllers/modal/modal-revision","job-contract/controllers/form/form-general","job-contract/controllers/form/form-hour","job-contract/controllers/form/form-health","job-contract/controllers/form/form-pay","job-contract/controllers/form/form-pension","job-contract/directives/directives","job-contract/directives/contact","job-contract/directives/directives","job-contract/directives/loader","job-contract/directives/number","job-contract/directives/validate","job-contract/filters/filters","job-contract/filters/capitalize","job-contract/filters/get-obj-by-id","job-contract/filters/format-amount","job-contract/filters/format-period","job-contract/filters/parse-int","job-contract/services/services","job-contract/services/contract","job-contract/services/contract-revision-list","job-contract/vendor/job-summary"],function(e){"use strict";e.module("hrjc",["ngAnimate","compuNgRoute","ngResource","angularFileUpload","ui.bootstrap","ui.select","common.angularDate","common.services","common.directives","hrjc.controllers","hrjc.directives","hrjc.filters","hrjc.services"]).constant("settings",{classNamePrefix:"hrjc-",contactId:CRM.jobContractTabApp.contactId,debug:+CRM.debug,pathApp:CRM.jobContractTabApp.path,pathFile:CRM.url("civicrm/hrjobcontract/file/"),pathReport:CRM.url("civicrm/report/hrjobcontract/summary"),pathRest:CRM.url("civicrm/ajax/rest"),pathTpl:CRM.jobContractTabApp.path+"views/",CRM:{options:CRM.FieldOptions||{},defaultCurrency:CRM.jobContractTabApp.defaultCurrency,apiTsFmt:"YYYY-MM-DD HH:mm:ss",fields:CRM.jobContractTabApp.fields,maxFileSize:CRM.jobContractTabApp.maxFileSize}}).config(["settings","$routeProvider","$resourceProvider","$logProvider","$httpProvider","uibDatepickerConfig","uiSelectConfig",function(e,t,n,r,o,i,a){r.debugEnabled(e.debug),t.resolveForAll({format:["DateFormat",function(e){return e.getDateFormat()}]}).when("/",{controller:"ContractListCtrl",templateUrl:e.pathApp+"views/contractList.html",resolve:{contractList:["ContractService",function(e){return e.get()}]}}).otherwise({redirectTo:"/"}),n.defaults.stripTrailingSlashes=!1,o.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",a.theme="bootstrap",i.showWeeks=!1}]).run(["settings","$rootScope","$q","$log","ContractService","ContractDetailsService","ContractHourService","ContractPayService","ContractLeaveService","ContractHealthService","ContractPensionService",function(e,t,n,r,o,i,a,c,s,l,u){r.debug("app.run"),t.pathTpl=e.pathTpl,t.prefix=e.classNamePrefix,n.all({contract:o.getRevisionOptions(),details:i.getOptions(),hour:a.getOptions(),pay:c.getOptions(),leave:s.getOptions(),health:l.getOptions(),pension:u.getOptions()}).then(function(e){e.pay.pay_is_auto_est=["No","Yes"],e.pension.is_enrolled=["No","Yes","Opted out"],r.debug("OPTIONS:"),r.debug(e),t.options=e})}])}),function(e,t){var n=e.jobContractTabApp.path+"js/src/job-contract";t.config({urlArgs:"bust="+(new Date).getTime(),paths:{"job-contract":n,"job-contract/vendor/fraction":n+"/vendor/fraction","job-contract/vendor/job-summary":n+"/vendor/jobsummary"},shim:{"job-contract/vendor/job-summary":{deps:["common/moment"]}}}),t(["job-contract/app"],function(){"use strict";document.dispatchEvent("function"==typeof window.CustomEvent?new CustomEvent("hrjcReady"):function(){var e=document.createEvent("Event");return e.initEvent("hrjcReady",!0,!0),e}())})}(CRM,require);